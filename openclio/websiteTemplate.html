<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chat-data browser</title>
<script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.0.2/wordcloud2.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg-0:#121212;--bg-1:#1e1e1e;--bg-2:#262626;--border:#333;
  --txt-0:#e0e0e0;--txt-1:#9e9e9e;--accent:#2ea8ff;--accent-hi:#6ec1ff;
  --assist:#30336b;--radius:.55rem;--shadow:0 8px 24px rgba(0,0,0,.35);
  --trans:.25s cubic-bezier(.25,.8,.25,1);
  color-scheme:dark;
}
*{box-sizing:border-box;margin:0;padding:0;font:16px/1.45 "Inter",system-ui}
html,body{height:100%}
body{background:var(--bg-0);color:var(--txt-0);padding:1.25rem;overflow-x:hidden}
.tree{list-style:none}
.tree li{position:relative;padding-left:1.25rem}
.tree li::before{content:"";position:absolute;left:0;top:calc(.9rem + 2px);width:.75rem;height:1px;background:var(--border)}
summary{position:relative;cursor:pointer;outline:none;user-select:none;display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .25rem;margin-left:-.25rem;border-radius:var(--radius)}
summary:hover{color:var(--accent-hi)}
details>summary::-webkit-details-marker{display:none}
summary:hover::after{content:"";position:absolute;left:-.25rem;right:-.25rem;top:0;height:100%;background:var(--bg-2);border-radius:var(--radius);z-index:-1}
.name{font-weight:600}
.summary{color:var(--txt-1);font-size:.8rem}
.stats{color:var(--txt-1);font-size:.75rem}
details[open]>ul{animation:fadeDown var(--trans) ease-out}
@keyframes fadeDown{from{opacity:0;max-height:0}to{opacity:1;max-height:2000px}}
.spinner{display:inline-block;width:1em;height:1em;border:.15em solid var(--border);border-right-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(1turn)}}
.msg{padding:.5rem .8rem;border-radius:var(--radius);max-width:65ch;font-size:.9rem;margin:.25rem 0;white-space:pre-wrap;background:var(--bg-2)}
.msg.user{background:var(--accent);color:#000}
.msg.assistant{background:var(--assist)}
.role{font-weight:600;margin-right:.3rem;font-family:monospace}
.msg pre{background:#0004;padding:.6rem;border-radius:var(--radius);overflow:auto}
.msg code{background:#0004;padding:.1rem .35rem;border-radius:.35rem;font-family:monospace}
.facets{margin:.7rem 0;display:flex;flex-wrap:wrap;gap:.35rem}
.facetBubble{color:#000;font-weight:600;border-radius:var(--radius);padding:.25rem .6rem;background:var(--accent);font-size:.75rem}
.hidden{display:none}
#modalWrap{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:999;opacity:0;pointer-events:none;transition:opacity var(--trans)}
#modalWrap.show{opacity:1;pointer-events:auto}
.modal{background:var(--bg-1);border-radius:var(--radius);padding:1.2rem;max-width:90vw;max-height:90vh;display:flex;flex-direction:column;box-shadow:var(--shadow);overflow:auto}
.closeBtn{align-self:flex-end;background:none;border:none;color:var(--txt-1);font-size:1.6rem;line-height:1;cursor:pointer;transition:color var(--trans)}
.closeBtn:hover{color:var(--accent-hi)}
::-webkit-scrollbar{width:.5rem}
::-webkit-scrollbar-thumb{border-radius:1rem;background:#555}
::-webkit-scrollbar-track{background:#222}


.plotBtns{
  display:flex;
  justify-content:flex-end;   /* right-align inside the panel */
  gap:.35rem;
}


.plotDock{
  position:fixed;top:.75rem;right:.75rem;z-index:50;
  width:260px;height:260px;padding:.35rem;background:var(--bg-1);
  border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:var(--shadow);transition:all var(--trans);
}
.plotDock.smol{
  display:flex;flex-direction:column;gap:.35rem
}
.plotDock.max{
  top: 1.25rem;               /* same as your body padding   */
  right: 1.25rem;
  bottom: 1.25rem;
  left: 1.25rem;
  width: auto; height: auto;  /* let flexbox stretch */
  border-radius: var(--radius);
}
.plotDock.max #plotCanvas{
  display:block;      /* makes margin auto work */
  margin:0 auto;      /* left & right auto  ‚áí  horizontal centre */
}
.plotDock.hide{transform:translateX(110%);pointer-events:none;opacity:0}
#plotToggle,#plotMax{
  align-self:flex-end;background:none;border:none;color:var(--txt-1);
  font-size:1.25rem;cursor:pointer;padding:.1rem .4rem;line-height:1
}
#plotToggle:hover,#plotMax:hover{color:var(--accent-hi)}
#plotSelect{
  width:100%;background:var(--bg-2);color:var(--txt-0);
  border:1px solid var(--border);border-radius:var(--radius);
  padding:.2rem .4rem;font-size:.8rem
}
#plotCanvas{flex:1;background:#000;border-radius:var(--radius)}
#plotToggle,#plotMax{
  align-self:auto;            /* override earlier ‚Äúflex-end‚Äù */
}

#plotHideAll{background:none;border:none;color:var(--txt-1);
            font-size:1.25rem;cursor:pointer;padding:.1rem .4rem;line-height:1}
#plotHideAll:hover{color:var(--accent-hi)}


/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ eye toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.eyeToggle{
  font-size:1rem;
  cursor:pointer;
  margin-right:.35rem;   /* ‚Üê change */
  margin-left:0;         /* ‚Üê change */
  opacity:.55;
  transition:opacity var(--trans);
  user-select:none;
}
.eyeToggle.on{opacity:1}       /* highlighted when hull is shown  */
.eyeToggle:hover{opacity:.9}


#plotLeaf{
  position:fixed;
  top:1.25rem;      /* align with body padding */
  right:0;          /* attach to right edge   */
  transform:none;
  background:var(--bg-1);
  border:1px solid var(--border);
  border-radius:.5rem 0 0 .5rem;   /* rounded on the left side */
  padding:.35rem .55rem;
  font-size:1.25rem;
  color:var(--txt-1);
  cursor:pointer;
  opacity:.65;
  transition:opacity var(--trans);
  z-index:51;
}
#plotLeaf:hover{opacity:1}
.hidden{display:none}       /* already exists ‚Äì reused here */
#treePane.hide { display:none; }


#loading.hidden { display:none; }
#loading{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;     /* NEW ‚Äì stack children vertically   */
  align-items:center;
  justify-content:center;
  gap:.6rem;                 /* optional: space between text + spinner */
  background:rgba(0,0,0,.45);
  z-index:998;
}
/* frequency chips under the ‚ÄúSelected conversations‚Äù panel */
#freqBox{
  margin-top:.7rem;
  display:flex;
  flex-wrap:wrap;
  gap:.35rem;
}
.freqChip{
  background:var(--bg-2);
  padding:.25rem .55rem;
  border-radius:var(--radius);
  font-size:.75rem;
  white-space:nowrap;
}

#loadMsg{
  margin-bottom:.6rem;
  font-size:.9rem;
  color:#fff;                       /* keep the white fill */

  /* 1 ‚Äì modern browsers that support strokes */
  -webkit-text-stroke:0.1px #000;   /* Chrome / Safari */

  /* 2 ‚Äì fallback outline made of shadows (Firefox, Edge-old, ‚Ä¶) */
  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000;
}

#plotCanvas{touch-action:none;}   /* allow custom dragging */
</style>
</head>

<body>
<h1 style="margin-bottom:.8rem;font-size:1.7rem">Chat-data hierarchy browser</h1>

<button id="treeToggle" class="hidden">Show tree</button>
<span id="loadAllBtnSpace" class="hidden">
<br /><br />
<button id="loadAllBtn">load all</button> 
</span>
<div id="treePane"><ul id="treeRoot" class="tree"></ul></div>

<div id="modalWrap" class="hidden">
  <div class="modal">
  
    <div id="selNav" style="margin:.6rem 0;display:flex;gap:.35rem">
      <button id="navPrev">‚óÄ</button>
      <button id="navNext">‚ñ∂</button>
      <span style="flex:1"></span>
    </div>
    <button class="closeBtn" title="Esc">‚úï</button>
    <div id="convContent"></div>
  </div>
</div>
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ selected-conversations panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  
<div id="selPane" class="hidden">
<div id="pager" class="hidden" style="margin-top:.6rem;display:flex;gap:.4rem">
    <button id="prevPage">‚óÄ prev</button>
    <span id="pageInfo" style="flex:1;text-align:center"></span>
    <button id="nextPage">next ‚ñ∂</button>
  </div>
  <h2 style="margin:.3rem 0 .6rem">Selected conversations</h2>
  <div id="selList"></div>
  
<div id="pager2" class="hidden" style="margin-top:.6rem;display:flex;gap:.4rem">
    <button id="prevPage2">‚óÄ prev</button>
    <span id="pageInfo2" style="flex:1;text-align:center"></span>
    <button id="nextPage2">next ‚ñ∂</button>
  </div>
<details id="wcWrap" style="margin-top:.9rem">
  <summary style="cursor:pointer;font-weight:600">
    <span id="wordCloudTitle">Word-cloud</span> <span style="font-size:.8rem;color:var(--txt-1)">‚ñº click</span>
  </summary>
  <canvas id="wcCanvas" width="600" height="400"
          style="display:block;margin-top:.6rem;max-width:100%;"></canvas>
</details>

<details id="wcWrap" style="margin-top:.9rem">
  <summary style="cursor:pointer;font-weight:600">
    Frequencies <span style="font-size:.8rem;color:var(--txt-1)">‚ñº click</span>
  </summary>
  <div id="freqBox"></div>
</details>
  <!-- NEW: slot for the frequency chips -->
</div>
<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ scatter-plot overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="plotWrap"  class="plotDock smol">
     <div class="plotBtns">
     <select id="plotSelect" title="Choose facet"></select>
     <button id="plotHideAll" title="Hide all clusters (x)">üëÅ</button>
      <button id="plotMax"    title="Maximise (m)">‚•§</button>
      <button id="plotToggle" title="Hide (h)">‚§´</button>
    </div>
  <canvas id="plotCanvas"></canvas>
</div>
<div id="plotLeaf" class="hidden" title="Show plot (h)">‚óÄ</div>
<div id="loading" class="hidden">
<span id="loadMsg">Loading‚Ä¶</span>
  <span class="spinner"></span>
</div>
<script>
var selConvFile = -1,
    selConvItem = -1;

var treeNavArr = null; // array with the conversations of that node
var treeNavInd = -1; // its path in the hierarchy
var treeRootConvs = null;
var treeNavPath = null;
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ mini-map globals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const plotCanvas = document.getElementById('plotCanvas');
const plotCtx = plotCanvas.getContext('2d');
const plotWrap = document.getElementById('plotWrap');
const plotToggle = document.getElementById('plotToggle');
const plotMaxBtn = document.getElementById('plotMax');
const plotSelect = document.getElementById('plotSelect');

const plotLeaf = document.getElementById('plotLeaf');
const plotHideAll = document.getElementById('plotHideAll');

const selPane = document.getElementById('selPane');
const selList = document.getElementById('selList');
const pager = document.getElementById('pager');
const prevPage = document.getElementById('prevPage');
const nextPage = document.getElementById('nextPage');
const pageInfo = document.getElementById('pageInfo');
const pager2 = document.getElementById('pager2');
const prevPage2 = document.getElementById('prevPage2');
const nextPage2 = document.getElementById('nextPage2');
const pageInfo2 = document.getElementById('pageInfo2');

const treePane = document.getElementById('treePane');
const navPrevBtn = document.getElementById('navPrev');
const navNextBtn = document.getElementById('navNext');
const treeTglBtn = document.getElementById('treeToggle');

const loadAllBtn = document.getElementById('loadAllBtn');
const loadAllBtnSpace = document.getElementById('loadAllBtnSpace');
const loading = document.getElementById('loading');

let selRect = null; // {minX,maxX,minY,maxY} in canvas pixels

function setLoad(txt) {
    loadMsg.textContent = txt;
}
const loadMsg = document.getElementById('loadMsg');

const wordCloudTitle = document.getElementById("wordCloudTitle");


function showTreeToggle(yes) {
    loadAllBtnSpace.classList.toggle("hidden", !yes);
    treeTglBtn.classList.toggle('hidden', !yes);
}

function clearSelection() {
    selResults = [];
    selRect = null;
    selPane.classList.add('hidden');
    drawPoints();
    showTreeToggle(false);
    showTree(true);
    updateHash();
}

function showTree(yes) {
    if (yes) {
        treePane.classList.remove('hide');
    } else {
        treePane.classList.add('hide');
    }
    treeTglBtn.textContent = yes ? 'hide tree' : 'üìÇ tree';
}
treeTglBtn.onclick = clearSelection;
document.addEventListener('keydown', e => {
    if (e.key === 't' && !treeTglBtn.classList.contains('hidden')) clearSelection();
});
document.addEventListener('keydown', e => {
    if (e.key === 't') treeTglBtn.onclick();
});


function updateModalNav(idxTotal, idxNow) {
    navPrevBtn.disabled = idxNow === 0;
    navNextBtn.disabled = idxNow === idxTotal - 1;
}

navPrevBtn.onclick = () => jumpRel(-1);
navNextBtn.onclick = () => jumpRel(+1);

function jumpRel(delta) {

    /* 1 ‚Äì if modal came from a box selection */
    if (selResults.length) {
        const pos = selResults.findIndex(({
                fileI,
                itemI
            }) =>
            fileI === curFile && itemI === curItem);
        if (pos < 0) return;
        const next = selResults[pos + delta];
        if (next) loadAndShowConversation(next.fileI, next.itemI);
        return;
    }

    /* 2 ‚Äì if modal came from the tree view */
    if (treeNavArr) {
        const nextIdx = parseInt(curItem) + delta;
        if (nextIdx >= 0 && nextIdx < treeNavArr.length) {
            curItem = nextIdx;
            openConversation(treeNavArr[nextIdx], treeNavPath, nextIdx, treeRootConvs);
        }
    }
}

let curFile = -1,
    curItem = -1; // remember what the modal shows

const PAGE_SIZE = 50;
let selResults = []; // [{fileI, itemI}, ‚Ä¶]
let curPage = 0;

async function renderSelPage(alreadyLoading) {
    const total = selResults.length;
    const pages = Math.ceil(total / PAGE_SIZE) || 1;

    // clamp page index
    curPage = Math.min(Math.max(curPage, 0), pages - 1);

    // slice rows for this page
    const start = curPage * PAGE_SIZE;
    const rows = selResults.slice(start, start + PAGE_SIZE);

    selList.innerHTML = '';
    rows.forEach(({
        fileI,
        itemI
    }, i) => {
        const btn = document.createElement('button');
        btn.dataset.f = fileI; // ‚Üê NEW
        btn.dataset.i = itemI; // ‚Üê NEW
        btn.textContent = `conv ${start + i + 1}`;
        btn.onclick = () => loadAndShowConversation(fileI, itemI);
        selList.appendChild(btn);
        selList.appendChild(document.createElement("br"));
    });

    // pager
    pageInfo.textContent = `${curPage + 1} / ${pages}`;
    pageInfo2.textContent = `${curPage + 1} / ${pages}`;
    pager.classList.toggle('hidden', pages === 1);
    pager2.classList.toggle('hidden', pages === 1);
    prevPage.disabled = curPage === 0;
    prevPage2.disabled = curPage === 0;
    nextPage.disabled = curPage === pages - 1;
    nextPage2.disabled = curPage === pages - 1;

    await preloadCurrentPage(alreadyLoading); // ensure data + update labels
    [...selList.children].forEach(maybeUpdateLabel);
    storeFrequencies();
    renderFrequencies();
    buildWordCloud();
}
prevPage.onclick = async () => {
    curPage--;
    await renderSelPage(false);
};
nextPage.onclick = async () => {
    curPage++;
    await renderSelPage(false);
};
prevPage2.onclick = async () => {
    curPage--;
    await renderSelPage(false);
};
nextPage2.onclick = async () => {
    curPage++;
    await renderSelPage(false);
};

async function loadAndShowConversation(fileI, itemI) {
    curFile = fileI;
    curItem = itemI;

    loading.classList.remove('hidden'); // ‚ë† show spinner

    try {
        const mapping = conversationsMappings.get(plotSelect.value);
        const baseURL = mapping.baseUrl;
        const fileURL = `${baseURL}data${fileI}.json.gz`;

        if (!loadAndShowConversation.cache) loadAndShowConversation.cache = new Map();
        let convArr = loadAndShowConversation.cache.get(fileURL);
        if (!convArr) {
            convArr = PASSWORD_PROTECTED ?
                (await decryptPasswordProtectedFile(fileURL)).conversationsData :
                (await fetchJsonGz(fileURL)).conversationsData;
            loadAndShowConversation.cache.set(fileURL, convArr);
        }

        openConversationSimple(convArr[itemI]);

        await renderSelPage(true);
    } finally {
        loading.classList.add('hidden'); // ‚ë° hide spinner
    }
}

function openConversationSimple(conversation) {
    //openConvHash=`c!${join(pathArr)}!${idx}`;
    convContent.innerHTML = '';
    if (conversation.allFacetValues?.length) {
        const colors = ['#ff7675', '#74b9ff', '#55efc4', '#fdcb6e', '#ffeaa7', '#a29bfe', '#fab1a0', '#81ecec'];
        const box = $('div', {
            class: 'facets'
        });
        conversation.allFacetValues.forEach((fv, i) => {
            box.appendChild($('div', {
                    class: 'facetBubble',
                    style: `background:${colors[i%colors.length]}`
                },
                `${fv.facet}: ${fv.value}`));
        });
        convContent.appendChild(box);
    }
    conversation['conversation'].forEach(m => {
        const d = $('div', {
                class: `msg ${m.role}`
            },
            $('span', {
                class: 'role'
            }, m.role + ': '));
        const span = $('span', {});
        span.innerHTML = mdToHtml(m.content);
        d.appendChild(span);
        convContent.appendChild(d);
    });
    modalWrap.classList.add('show');
    modalWrap.classList.remove('hidden');

    if (selResults.length) {
        updateModalNav(selResults.length, selResults.findIndex(r => r.fileI === curFile && r.itemI === curItem));
        selConvFile = curFile;
        selConvItem = curItem;
    }

    updateHash();
}


function hideAllHulls() {
    /* 1‚Ää‚Äì‚Ääclear the map & repaint */
    hullVisible.clear();
    drawPoints();

    /* 2‚Ää‚Äì‚Äädim every eye icon that was on */
    document.querySelectorAll('.eyeToggle.on')
        .forEach(el => el.classList.remove('on'));
}

plotHideAll.onclick = hideAllHulls;

/* optional keyboard shortcut */
document.addEventListener('keydown', e => {
    if (e.key === 'x') hideAllHulls();
    if (e.key == "ArrowRight") jumpRel(1);
    if (e.key == "ArrowLeft") jumpRel(-1);
});

var facetOptions = new Map(); // label ‚Üí url
let curPoints = []; // active array  [[x,y],‚Ä¶]
let xyMinMax = null; // {xmin,xmax,ymin,ymax}


const $ = (t, a = {}, ...k) => {
    const e = document.createElement(t);
    for (const [key, val] of Object.entries(a)) {
        if (key.startsWith('on')) e.addEventListener(key.slice(2), val);
        else if (key === 'class') e.className = val;
        else e.setAttribute(key, val);
    }
    k.flat().forEach(c => {
        if (c) {

            e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
        }
    });
    return e;
};
const spinner = () => $('span', {
    class: 'spinner',
    title: 'Loading‚Ä¶'
});
async function fetchJson(u) {
    const res = await fetch(u, {
        cache: 'reload'
    });
    if (!res.ok) throw new Error(res.status);
    // we used compressed jsons
    return res.json();
}

function sleep(seconds) {
    return new Promise(resolve => setTimeout(resolve, seconds * 1000));
}


/* ---------- facet-points helpers ---------- */


async function toggleHullForNode(node) {
    const p = join(node.__pathArr);
    const facetName = facetIToStr[node.__faceti];
    if (plotSelect.value !== facetName) { // not already selected
        plotSelect.value = facetName; // move the <select>
        await loadDraw(facetOptions.get(facetName)); // load (if needed)
    }
    const eye = node.__eye;
    if (hullVisible.has(p)) { // currently on ‚Üí turn off
        hullVisible.delete(p);
        eye.classList.remove('on');
    } else { // off ‚Üí turn on
        addHull(node);
        eye.classList.add('on');
    }
    drawPoints();
}

var pointsCache = new Map(); // url ‚Üí Promise

async function getPoints(url) {
    if (!pointsCache.has(url))
        pointsCache.set(url, await loadPointsLE(url));
    return pointsCache.get(url);
}

function calcMinMax(arr) {
    let xmin = +Infinity,
        xmax = -Infinity,
        ymin = +Infinity,
        ymax = -Infinity;
    for (const [x, y] of arr) {
        if (x < xmin) xmin = x;
        if (x > xmax) xmax = x;
        if (y < ymin) ymin = y;
        if (y > ymax) ymax = y;
    }
    var xSpan = xmax - xmin;
    // puff out a little so things aren't on border
    xmin -= xSpan * 0.03;
    xmax += xSpan * 0.03;
    var ySpan = ymax - ymin;
    // puff out a little so things aren't on border
    ymin -= ySpan * 0.03;
    ymax += ySpan * 0.03;
    return {
        xmin,
        xmax,
        ymin,
        ymax
    };
}

/* ---------- hull helpers ---------- */
var hullVisible = new Map(); // path ‚Üí {idx,color}
const hullColors = [
    '#ff767580', /* red            */
    '#e1705580', /* orange-brown   */
    '#55efc480', /* green          */
    '#fdcb6e80', /* yellow         */
    '#ffeaa780', /* pale-yellow    */
    '#d980fa80', /* violet         */
    '#fab1a080', /* salmon         */
    '#6c5ce780' /* indigo         */
];

function addHull(node) {
    if (!node.__concaveHull || !curPoints.length) return;
    const p = join(node.__pathArr);
    if (hullVisible.has(p)) return;
    hullVisible.set(p, {
        idx: node.__concaveHull,
        color: hullColors[hullVisible.size % hullColors.length],
        facetI: node.__faceti
    });
    drawPoints(); // redraw incl. new hull
}

function removeHull(node) {
    hullVisible.delete(join(node.__pathArr));
    if (node.__eye) node.__eye.classList.remove('on'); // <‚îÄ new
    drawPoints();
}

function pointInPoly(poly, x, y) {
    let c = false;
    for (let i = 0, j = poly.length - 1; i < poly.length; j = i++)
        ((poly[i][1] > y) != (poly[j][1] > y)) &&
        (x < (poly[j][0] - poly[i][0]) * (y - poly[i][1]) / (poly[j][1] - poly[i][1]) + poly[i][0]) &&
        (c = !c);
    return c;
}

var cachedPlot = null;
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Replaces the previous drawPoints()
//  ‚Äì draws all points bright
//  ‚Äì dims everything with a translucent veil
//  ‚Äì punches transparent holes in that veil for every
//    currently-visible hull belonging to the selected facet
//  ‚Äì finally fills the hull polygons themselves (as before)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawPoints() {
    if (!curPoints.length) return;

    /* ---------- sizing & scaling ---------- */
    const cssW = screen.availWidth * 0.9;
    const cssH = screen.availHeight * 0.8;
    const dpr = 1; // use window.devicePixelRatio if desired

    plotCanvas.width = cssW * dpr;
    plotCanvas.height = cssH * dpr;

    const {
        width: w,
        height: h
    } = plotCanvas;
    plotCtx.clearRect(0, 0, w, h);

    const {
        xmin,
        xmax,
        ymin,
        ymax
    } = xyMinMax;
    const sx = xmax === xmin ? 1 : w / (xmax - xmin);
    const sy = ymax === ymin ? 1 : h / (ymax - ymin);


    /* ---------- step 1: draw all points, but dimmer ---------- */
    plotCtx.fillStyle = '#6ec1ff22';
    for (const [x, y] of curPoints) {
        const px = (x - xmin) * sx;
        const py = (y - ymin) * sy;
        plotCtx.fillRect(px - 1, py - 1, 2, 2);
    }

    /* ---------- step 3: draw coloured hull polygons themselves ---------- */
    // how many CSS pixels you want the shape to grow OUTWARD
    const PUFF = 6; // try 4-10 and tweak to taste
    for (const [path, {
            idx,
            facetI,
            color
        }] of hullVisible) {

        if (facetIToStr[facetI] !== plotSelect.value) continue; // only active facet

        /* -------------------------------------------------------
           BUILD THE PATH (unchanged)
        ------------------------------------------------------- */
        plotCtx.beginPath();
        idx.forEach((i, j) => {
            const [x, y] = curPoints[i];
            const px = (x - xmin) * sx;
            const py = (y - ymin) * sy;
            j ? plotCtx.lineTo(px, py) : plotCtx.moveTo(px, py);
        });
        plotCtx.closePath();

        /* -------------------------------------------------------
           1) FAT STROKE IN FILL COLOUR  ‚Üí gives the ‚Äúpuff‚Äù
        ------------------------------------------------------- */
        plotCtx.save(); // isolate our tweaks
        plotCtx.strokeStyle = color; // same colour as fill
        plotCtx.lineJoin = "round"; // softer corners
        plotCtx.lineWidth = PUFF * 2; // outward growth = PUFF
        plotCtx.stroke();

        /* -------------------------------------------------------
           2) NORMAL FILL  (hides the inner half of the fat stroke)
        ------------------------------------------------------- */
        plotCtx.fillStyle = color;
        plotCtx.fill();

        /* -------------------------------------------------------
           3) OPTIONAL CRISP OUTLINE
              comment-out if you don‚Äôt want an edge
        ------------------------------------------------------- */
        plotCtx.lineWidth = 1.5;
        plotCtx.strokeStyle = "#00000088"; // translucent black
        plotCtx.stroke();

        plotCtx.restore(); // restore previous state
    }

    /* ---------- selection rectangle overlay ---------- */
    if (selRect) {
        const {
            minX,
            maxX,
            minY,
            maxY
        } = selRect;
        plotCtx.lineWidth = 3;
        plotCtx.strokeStyle = '#ff7675';
        plotCtx.setLineDash([8]);
        plotCtx.strokeRect(minX, minY, maxX - minX, maxY - minY);

        // fluffy fill
        plotCtx.fillStyle = '#ff767540'; // translucent red
        plotCtx.fillRect(minX, minY, maxX - minX, maxY - minY);
    }

    cachedPlot = plotCtx.getImageData(0, 0, plotCanvas.width, plotCanvas.height);

}

function resizeCanvas() {

    drawPoints(); // repaint with the new scale
}

/* ‚îÄ‚îÄ‚îÄ box selection on the same canvas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let dragging = false,
    sx = 0,
    sy = 0;

function clientToCanvas(ev) {
    const rect = plotCanvas.getBoundingClientRect();
    const p = plotCtx.getTransform().inverse().transformPoint(
        new DOMPoint(
            (ev.clientX - rect.left) / rect.width * plotCanvas.width,
            (ev.clientY - rect.top) / rect.height * plotCanvas.height
        ));
    return [p.x, p.y];
}

function countPointsInRect(minX, maxX, minY, maxY) {
    const {
        xmin,
        xmax,
        ymin,
        ymax
    } = xyMinMax,
    w = plotCanvas.width,
        h = plotCanvas.height,
        kx = xmax === xmin ? 1 : w / (xmax - xmin),
        ky = ymax === ymin ? 1 : h / (ymax - ymin);

    let inside = 0;
    for (const [x, y] of curPoints) {
        const px = (x - xmin) * kx,
            py = (y - ymin) * ky;
        if (px >= minX && px <= maxX && py >= minY && py <= maxY) inside++;
    }
    return inside;
}

function getPointIndicesInRect(minX, maxX, minY, maxY) {
    const {
        xmin,
        xmax,
        ymin,
        ymax
    } = xyMinMax,
    w = plotCanvas.width,
        h = plotCanvas.height,
        kx = xmax === xmin ? 1 : w / (xmax - xmin),
        ky = ymax === ymin ? 1 : h / (ymax - ymin);

    const hits = []; // ‚Üê indices go here
    for (let i = 0; i < curPoints.length; i++) {
        const [x, y] = curPoints[i];
        const px = (x - xmin) * kx,
            py = (y - ymin) * ky;
        if (px >= minX && px <= maxX && py >= minY && py <= maxY)
            hits.push(i);
    }
    return hits;
}

function plotIsMax() {
    return plotWrap.classList.contains('max');
}
/* pointer down  ‚Üí start rectangle */
plotCanvas.addEventListener('pointerdown', ev => {
    ev.preventDefault(); // block page-scroll on mobile
    if (!cachedPlot || !plotIsMax()) return; // safety
    [sx, sy] = clientToCanvas(ev);
    dragging = true;
});

/* pointer move  ‚Üí redraw cached bitmap + rubber-band */
plotCanvas.addEventListener('pointermove', ev => {
    ev.preventDefault(); // block page-scroll on mobile
    if (!dragging || !plotIsMax()) return;
    const [cx, cy] = clientToCanvas(ev);

    // restore cached plot
    plotCtx.putImageData(cachedPlot, 0, 0);

    // rectangle limits
    const minX = Math.min(sx, cx),
        maxX = Math.max(sx, cx),
        minY = Math.min(sy, cy),
        maxY = Math.max(sy, cy);

    // rubber-band
    plotCtx.setLineDash([6]);
    plotCtx.strokeStyle = '#ff7675';
    plotCtx.strokeRect(sx, sy, cx - sx, cy - sy);

    // live counter
    const n = countPointsInRect(minX, maxX, minY, maxY);
    plotCtx.setLineDash([]); // solid for text bg
    plotCtx.fillStyle = 'rgba(0,0,0,0.65)';
    const label = `${n} pts`;
    plotCtx.font = '14px/1 sans-serif';
    const textW = plotCtx.measureText(label).width + 8;
    plotCtx.fillRect(minX, minY - 20, textW, 18); // dark pill
    plotCtx.fillStyle = '#ffffff';
    plotCtx.fillText(label, minX + 4, minY - 6); // white text
});

/* pointer up    ‚Üí count points, restore bitmap */
plotCanvas.addEventListener('pointerup', async ev => {
    ev.preventDefault(); // block page-scroll on mobile
    if (!dragging || !plotIsMax()) return;
    dragging = false;

    const [cx, cy] = clientToCanvas(ev);
    plotCtx.putImageData(cachedPlot, 0, 0); // restore

    const minX = Math.min(sx, cx),
        maxX = Math.max(sx, cx),
        minY = Math.min(sy, cy),
        maxY = Math.max(sy, cy);

    const idxs = getPointIndicesInRect(minX, maxX, minY, maxY);

    // convert each point index into {fileI,itemI}
    const mapping = conversationsMappings.get(plotSelect.value);
    selResults = idxs.map(i => {
        const [fileI, itemI] = mapping.indices[i];
        return {
            fileI,
            itemI
        };
    });

    // show / hide panel
    if (selResults.length) {
        curPage = 0;
        selPane.classList.remove('hidden');

        // remember rectangle so we can redraw it
        selRect = {
            minX,
            maxX,
            minY,
            maxY
        };
        labelFrequencies.clear();
        wordFrequencies.clear();
        alreadyProcessed.clear();
        showTreeToggle(true); // NEW ‚Üê reveal the button
        plotWrap.classList.add('smol');
        plotWrap.classList.remove('max');
        showTree(false); // hide hierarchy while reviewing selection

        await renderSelPage(false);

    } else {
        selPane.classList.add('hidden');
        selRect = null; // nothing to show
        showTreeToggle(false); // NEW ‚Üê hide the button
        showTree(true); // hide hierarchy while reviewing selection
        clearSelection();
    }
    drawPoints();

    updateHash();
});

/* if the user aborts drag by leaving the canvas */
plotCanvas.addEventListener('pointerleave', () => {
    if (dragging && cachedPlot) plotCtx.putImageData(cachedPlot, 0, 0);
    dragging = false;
});

window.addEventListener('resize', resizeCanvas);

function loadProxyUrl(url) {
    //return  url.replace("YOURHTTPPREFIX", "https://raw.githubusercontent.com/YOUR_GITHUB_USER_NAME/YOUR_GITHUB_REPO/main");
    return url;
}


async function loadConversationsMapping(url) {
    url = loadProxyUrl(url);
    // 1. fetch the raw bytes
    const res = await fetch(url);
    const buffer = await res.arrayBuffer();

    // 2. wrap in a DataView (gives per-read endian control)
    const view = new DataView(buffer);

    // 3. walk through the bytes, 8-byte stride (4 for x, 4 for y)
    const pts = [];
    for (let off = 0; off < view.byteLength; off += 8) {
        const x = view.getInt32(off, /*littleEndian=*/ true);
        const y = view.getInt32(off + 4, /*littleEndian=*/ true);
        pts.push([x, y]);
    }
    return {
        "indices": pts,
        "baseUrl": url.replace("conversationsMapping.bin", "")
    };
}

async function loadPointsLE(url) {
    url = loadProxyUrl(url);
    // 1. fetch the raw bytes
    const res = await fetch(url);
    const buffer = await res.arrayBuffer();

    // 2. wrap in a DataView (gives per-read endian control)
    const view = new DataView(buffer);

    // 3. walk through the bytes, 8-byte stride (4 for x, 4 for y)
    const pts = [];
    for (let off = 0; off < view.byteLength; off += 8) {
        const x = view.getFloat32(off, /*littleEndian=*/ true);
        const y = view.getFloat32(off + 4, /*littleEndian=*/ true);
        pts.push([x, y]);
    }
    return pts;
}

async function addFacetOption(label, url) {
    if (facetOptions.has(label)) return;
    facetOptions.set(label, url);
    plotSelect.appendChild($('option', {
        value: label
    }, label));
    //if (plotSelect.selectedIndex === -1){      // first entry
    await loadDraw(url);
    plotSelect.value = label;
    //}
}

plotSelect.onchange = async () => {
    clearSelection();
    await loadDraw(facetOptions.get(plotSelect.value));
}

var ptsLookup = new Map();
var minMaxLookup = new Map();

async function loadDraw(url) {
    var pts;
    if (ptsLookup.has(url)) {
        pts = ptsLookup.get(url);
        xyMinMax = minMaxLookup.get(url);
    } else {
        pts = await getPoints(url);
        ptsLookup.set(url, pts);
        xyMinMax = calcMinMax(pts);
        minMaxLookup.set(url, xyMinMax);
    }
    curPoints = pts;
    resizeCanvas();
}

function hidePlot() {
    plotWrap.classList.add('hide');
    plotLeaf.classList.remove('hidden');
}

function showPlot() {
    plotWrap.classList.remove('hide');
    plotLeaf.classList.add('hidden');
}

plotToggle.onclick = hidePlot;
plotLeaf.onclick = showPlot;


plotMaxBtn.onclick = () => {
    plotWrap.classList.toggle('max');
    plotWrap.classList.toggle('smol');
    setTimeout(() => {
        //resizeCanvas();
        //drawPoints();
    }, 260); // wait for transition, then fit
};


document.addEventListener('keydown', e => {
    if (e.key === 'h') {
        if (plotWrap.classList.contains('hide')) showPlot();
        else hidePlot();
    }
    if (e.key === 'm') plotMaxBtn.onclick();
    if (e.key === 'x') hideAllHulls();
});

const MAGIC = new TextEncoder().encode("EJ01"); // 4-byte signature

async function deriveKey(password, salt, iterations) {
    const keyMaterial = await crypto.subtle.importKey(
        "raw", new TextEncoder().encode(password), "PBKDF2", false, ["deriveKey"]);
    return crypto.subtle.deriveKey({
            name: "PBKDF2",
            hash: "SHA-256",
            salt,
            iterations
        },
        keyMaterial, {
            name: "AES-GCM",
            length: 256
        }, false, ["decrypt"]);
}

var password = null;

function credAPIAvailable() {
    return ('credentials' in navigator) && ('PasswordCredential' in window);
}

/* ---------- retrieve (auto-fill) ---------- */
async function loadPwdViaCredAPI() {
    if (!credAPIAvailable()) {
        return null;
    }

    try {
        // unmediated:true  ‚áí silent auto-sign-in if the user allowed it
        const cred = await navigator.credentials.get({
            password: true,
            unmediated: true
        });
        return cred ? cred.password : null;
    } catch {
        return null;
    }
}

/* ---------- store (after user enters pwd) ---------- */
async function savePwdViaCredAPI(pwd) {
    if (!credAPIAvailable()) {
        return false;
    }

    // We need to supply an ‚Äúid‚Äù (username).  Use something stable:
    const id = location.origin;

    const cred = new PasswordCredential({
        id,
        password: pwd
    });
    try {
        await navigator.credentials.store(cred); // prompts the user
        return true;
    } catch {
        return false;
    }
}

async function decryptPasswordProtectedFile(url) {
    url = loadProxyUrl(url);
    var res;
    var numRetries = 5;
    for (var retryIter = 0; retryIter < numRetries; retryIter++) {
        res = await fetch(url, {
            cache: 'reload'
        });
        if (res.ok) break;
        if (retryIter == numRetries - 1) {
            throw new Error(res.status);
        } else {
            await sleep(1); // rate limit
        }
    }
    var alreadyHasPassword = password !== null;
    const arrayBuf = await res.arrayBuffer(); // wait here
    for (var attempts = 0; attempts < 10; attempts++) {
        try {
            if (!password) {
                password = await loadPwdViaCredAPI();
                if (!password) {
                    var promptStr = attempts > 0 ? "Wrong Password. Password?" : "Password?";
                    password = prompt(promptStr);
                }
            }
            const u8 = new Uint8Array(arrayBuf);
            const dv = new DataView(arrayBuf);

            /* 1 ‚îÄ validate header */
            for (let i = 0; i < 4; i++)
                if (u8[i] !== MAGIC[i]) throw "Bad magic";
            const iterations = dv.getUint32(4, true);
            const salt = u8.slice(8, 24);
            const nonce = u8.slice(24, 36);
            const data = u8.slice(36);

            /* 2 ‚îÄ PBKDF2 ‚Üí AES-GCM */
            const key = await deriveKey(password, salt, iterations);

            /* 3 ‚îÄ decrypt, gunzip, parse JSON */
            const plain = new Uint8Array(
                await crypto.subtle.decrypt({
                    name: "AES-GCM",
                    iv: nonce
                }, key, data));
            const json = JSON.parse(pako.ungzip(plain, {
                to: "string"
            }));
            if (!alreadyHasPassword) {
                savePwdViaCredAPI(password);
            }
            return json;
        } catch (err) {
            console.log(err);
            if (err instanceof DOMException && err.name === "OperationError") {
                password = null;
            } else
                throw err; // other I/O / JSON errors bubble up
        }

    }
}

async function fetchJsonGz(url) {
    url = loadProxyUrl(url); 
    var res;
    var numRetries = 5;
    for (var retryIter = 0; retryIter < numRetries; retryIter++) {
        res = await fetch(url, {
            cache: 'reload'
        });
        if (res.ok) break;
        if (retryIter == numRetries - 1) {
            throw new Error(res.status);
        } else {
            await sleep(1); // rate limit
        }
    }

    const ab = await res.arrayBuffer(); // wait here
    const buf = new Uint8Array(ab);
    const text = pako.ungzip(buf, {
        to: 'string'
    });


    return JSON.parse(text);
}

function join(p) {
    return p.join(".");
}

function split(s) {
    return s.split(".");
}
const getNum = i => i?.numConversations ?? i?.numConvs ?? 0;
const isPlaceholder = i => typeof i === 'object' && i !== null && 'path' in i && !('children' in i);
const count = getNum;
const sortByCount = a => [...a].sort((p, q) => count(q) - count(p));
const facetCount = f => Array.isArray(f.hierarchy) ? f.hierarchy.reduce((s, c) => s + count(c), 0) : 0;

const PASSWORD_PROTECTED = ISPASSWORDPROTECTED;
const ROOT = "ROOTOBJECTSJSON";
const POINTS_FILE = "ROOTPOINTS";
const pathMap = new Map();
let openConvHash = null;

var conversationsMappings = new Map();

var facetIToStr = {};

var RAW_EMBEDDING_NAME = "Conversation Embeddings";

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ root build ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
window.onload = () => fetchJson(ROOT).then(buildFacets);
async function buildFacets(raw) {
    await addFacetOption(RAW_EMBEDDING_NAME, POINTS_FILE);
    const facets = [...raw].sort((a, b) => facetCount(b) - facetCount(a));
    const root = document.getElementById('treeRoot');
    root.innerHTML = '';
    for (var fi = 0; fi < facets.length; fi++) {
        var f = facets[fi];
        const own = facetCount(f);
        const li = $('li', {},
            $('details', {},
                $('summary', {},
                    $('span', {
                        class: 'name'
                    }, f.facet?.name || 'Facet'),
                    own ? $('span', {
                        class: 'stats'
                    }, `${own}`) : null,
                    f.facet?.question ? $('span', {
                        class: 'summary'
                    }, f.facet.question) : null)));
        const details = li.firstChild;
        details.__childrenData = sortByCount(f.hierarchy);
        details.__faceti = fi;
        facetIToStr[fi] = f.facet?.name;

        if (f.points) {
            details.__pointsURL = f.points;
            await addFacetOption(f.facet?.name, f.points);
            details.__pointsLoaded = true;
        }
        if (f.conversationsMapping) {
            var mapping = await loadConversationsMapping(f.conversationsMapping);
            // use the first mapping for the raw embeddings as well
            if (!conversationsMappings.has(RAW_EMBEDDING_NAME)) {
                conversationsMappings.set(RAW_EMBEDDING_NAME, mapping);
            }
            conversationsMappings.set(f.facet?.name, mapping);
        }
        details.__pathArr = [`f${fi}`];
        details.addEventListener('toggle', handleToggle);
        pathMap.set('f' + fi, details);
        root.appendChild(li);

    }
    restoreFromHash();
    resizeCanvas();
}


/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ builders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function buildNode(faceti, item, pathArr, siblingTotal, rootConvs) {
    if (isPlaceholder(item)) return await buildPlaceholder(faceti, item, pathArr, siblingTotal);
    const p = join(pathArr);
    const details = $('details', {});
    pathMap.set(p, details);
    const own = count(item),
        pct = siblingTotal ? Math.round(own * 100 / siblingTotal) : 100;
    details.appendChild(
        $('summary', {},
            $('span', {
                class: 'name'
            }, item.name || '(unnamed)'),
            $('span', {
                class: 'stats'
            }, `${own} (${pct} %)`),
            item.summary ? $('span', {
                class: 'summary'
            }, item.summary) : null));
    details.__childrenData = sortByCount(item.children || []);
    details.__convs = item.conversations || null;
    details.__pathArr = pathArr;
    details.__concaveHull = item.concaveHull;
    details.__faceti = faceti;
    details.__rootConvs = rootConvs;
    if (details.__concaveHull) {
        // ‚ë† eye in the <summary>
        const eye = $('span', {
            class: 'eyeToggle',
            title: 'Toggle cluster'
        }, 'üëÅ');
        eye.onclick = async ev => { // stop the <details> toggle
            ev.stopPropagation();
            ev.preventDefault(); // cancel the <details> auto-toggle
            await toggleHullForNode(details);
        };
        // insert at the start
        details.firstChild.insertBefore(eye, details.firstChild.firstChild);

        // store a back-reference for later
        details.__eye = eye;
    }
    details.addEventListener('toggle', handleToggle);
    return $('li', {}, details);
}
async function buildPlaceholder(faceti, ph, pathArr, siblingTotal) {
    const url = ph.path,
        pathStr = join(pathArr);
    var data;
    if (PASSWORD_PROTECTED) {
        data = await decryptPasswordProtectedFile(url);
    } else {
        data = await fetchJsonGz(url);
    }
    return (data.children || data.conversations) ? await buildNode(faceti, data, pathArr, siblingTotal, data.conversationsData) : buildLeaf(url, data);
}

function buildLeaf(url, data) {
    const d = $('details', {}, $('summary', {}, url.split('/').pop()));
    d.appendChild($('pre', {}, JSON.stringify(data, null, 2).slice(0, 1000)));
    return $('li', {}, d);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ toggle handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function handleToggle(e) {
    const det = e.currentTarget;
    const parentPath = join(det.__pathArr);
    /* ‚îÄ eye visibility ‚îÄ */
    if (det.__eye) {
        //det.__eye.style.display = det.open ? 'none' : '';
    }

    if (det.open) {


        if (!det.__built && det.__childrenData) {
            const childTotal = det.__childrenData.reduce((s, i) => s + count(i), 0);
            const ul = $('ul', {
                class: 'tree'
            });
            det.appendChild(ul);
            for (var i in det.__childrenData) {
                var ch = det.__childrenData[i];
                var spinnerChild = "";
                if (isPlaceholder(ch)) {
                    spinnerChild = $('li', {}, spinner());
                    ul.appendChild(spinnerChild);
                }
                var childNode = await buildNode(det.__faceti, ch, [...det.__pathArr, i], childTotal, det.__rootConvs);
                if (isPlaceholder(ch)) {
                    spinnerChild.replaceWith(childNode);
                } else {
                    ul.appendChild(childNode);
                }
            }
            det.__built = true;
        }
        if (det.__convs && !det.__convsBuilt) {
            const cDet = $('details', {}, $('summary', {}, `Conversations (${det.__convs.length})`));
            const cUL = $('ul', {
                class: 'tree'
            });

            det.__convs.forEach((c, i) => {
                const ent = $('details', {}, $('summary', {}, det.__rootConvs[c].facetValue || `Conversation #${i+1}`));
                ent.firstChild.addEventListener('click', ev => {
                    treeNavArr = det.__convs;
                    treeRootConvs = det.__rootConvs;
                    curItem = i;
                    ev.stopPropagation();
                    openConversation(c, det.__pathArr, i, det.__rootConvs);
                });
                cUL.appendChild($('li', {}, ent));
            });
            cDet.appendChild(cUL);
            det.appendChild(cDet);
            const cKey = parentPath + '$c';
            cDet.__pathArr = [...det.__pathArr];
            pathMap.set(cKey, cDet);
            cDet.addEventListener('toggle', updateHash);
            det.__convsBuilt = true;
        }
    } else {
        det.querySelectorAll(':scope > ul.tree, :scope > details').forEach(n => n.remove());
        det.__built = false;
        det.__convsBuilt = false;
        for (const key of [...pathMap.keys()]) {
            if (key.startsWith(parentPath + '.') || key === parentPath + '$c') {
                pathMap.delete(key);
            }
        }
        var removedAny = false;
        for (const [path, {
                idx,
                facetI,
                color
            }] of [...hullVisible]) {
            if (path.startsWith(parentPath + '.')) {
                hullVisible.delete(path);
                removedAny = true;
            }
        }
        if (removedAny) {
            drawPoints();
        }
        if (openConvHash && openConvHash.startsWith(`c!${parentPath}.`)) closeConversation();
    }
    updateHash();
}


const modalWrap = document.getElementById('modalWrap');
const convContent = document.getElementById('convContent');
document.querySelector('.closeBtn').onclick = closeConversation;
modalWrap.addEventListener('click', e => {
    if (e.target === modalWrap) closeConversation();
});
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeConversation();
});

function openConversation(obj, pathArr, idx, convsArr) {
    obj = convsArr[obj];
    treeNavPath = pathArr;
    updateModalNav(treeNavArr.length, idx); // enable / disable arrows
    openConvHash = `c!${join(pathArr)}!${idx}`;
    convContent.innerHTML = '';
    if (obj.allFacetValues?.length) {
        const colors = ['#ff7675', '#74b9ff', '#55efc4', '#fdcb6e', '#ffeaa7', '#a29bfe', '#fab1a0', '#81ecec'];
        const box = $('div', {
            class: 'facets'
        });
        obj.allFacetValues.forEach((fv, i) => {
            box.appendChild($('div', {
                    class: 'facetBubble',
                    style: `background:${colors[i%colors.length]}`
                },
                `${fv.facet}: ${fv.value}`));
        });
        convContent.appendChild(box);
    }
    obj.conversation.forEach(m => {
        const d = $('div', {
                class: `msg ${m.role}`
            },
            $('span', {
                class: 'role'
            }, m.role + ': '));
        const span = $('span', {});
        span.innerHTML = mdToHtml(m.content);
        d.appendChild(span);
        convContent.appendChild(d);
    });
    modalWrap.classList.add('show');
    modalWrap.classList.remove('hidden');
    updateHash();
}

function closeConversation() {
    selConvFile = selConvItem = -1;
    if (!modalWrap.classList.contains('show')) return;
    modalWrap.classList.remove('show');
    setTimeout(() => modalWrap.classList.add('hidden'), 250);
    openConvHash = null;
    updateHash();
}

function mdToHtml(t = '') {
    let h = t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    h = h.replace(/```([\s\S]*?)```/g, (m, c) => `<pre><code>${c}</code></pre>`);
    h = h.replace(/`([^`]+?)`/g, '<code>$1</code>');
    h = h.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    h = h.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    return h.replace(/\n/g, '<br>');
}


var curHash = "";

window.addEventListener("hashchange", function(event) {
    if (window.location.hash != curHash && modifyHashAllowed) {
        restoreFromHash().then(() => {
            curHash = window.location.hash;
        });
    }
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ hash sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function updateHash() {
    if (!modifyHashAllowed) return;
    const tokens = [...pathMap.entries()]
        .filter(([, d]) => d.open)
        .map(([p]) => p);

    if (openConvHash) tokens.push(openConvHash);

    if (selRect) {
        const {
            minX,
            minY,
            maxX,
            maxY
        } = selRect;

        const w = plotCanvas.width,
            h = plotCanvas.height;
        const nx1 = (minX / w).toFixed(4),
            ny1 = (minY / h).toFixed(4),
            nx2 = (maxX / w).toFixed(4),
            ny2 = (maxY / h).toFixed(4);
        tokens.push(`r!${nx1}=${ny1}=${nx2}=${ny2}`);
        tokens.push(`p!${curPage|0}`);
        if (selConvFile >= 0)
            tokens.push(`s!${selConvFile}.${selConvItem}`);
    }
    tokens.push(`fa!${encodeURIComponent(plotSelect.value)}`);

    hashStr = [...tokens].join(',');
    const compressedBase64 = LZUTF8.encodeBase64(LZUTF8.compress(hashStr));
    curHash = "#" + encodeURIComponent(compressedBase64);
    window.location.hash = curHash;
}
let modifyHashAllowed = true;

async function expandPath(pathStr) {
    const segs = split(pathStr);
    const prefix = [];
    for (const seg of segs) {
        prefix.push(seg);
        const cur = join(prefix);
        let det = pathMap.get(cur);
        if (det && !det.open) {
            det.removeEventListener('toggle', handleToggle);
            det.open = true;
            removeHull(det);
            await handleToggle({
                currentTarget: det
            }); // run it yourself
            det.addEventListener('toggle', handleToggle);
        }
    }
}

async function restoreFromHash() {

    loading.classList.remove('hidden'); // ‚ë† show spinner
    setLoad('loading tree state‚Ä¶');
    try {
        modifyHashAllowed = false;
        hashStr = window.location.hash;
        if (hashStr.length > 0) {
            try {
                hashStr = decodeURIComponent(hashStr.substring(1)) // remove #
                hashStr = LZUTF8.decompress(LZUTF8.decodeBase64(hashStr), {
                    inputEncoding: "ByteArray",
                    outputEncoding: "String"
                });
            } catch {
                hashStr = ""
            }
        }
        curHash = window.location.hash;
        var facetTok = null,
            rectTok = null,
            pageTok = null,
            selConvTok = null;
        const segs = decodeURIComponent(hashStr).split(',').filter(Boolean);
        const convSeg = segs.find(s => s.startsWith('c!'));

        const catSegs = [],
            convListSegs = [];

        segs.forEach(s => {
            if (s.startsWith('fa!')) facetTok = s;
            else if (s.startsWith('r!')) rectTok = s;
            else if (s.startsWith('p!')) pageTok = s;
            else if (s.startsWith('s!')) selConvTok = s;
            else if (s && s !== convSeg) {
                s.endsWith('$c') ? convListSegs.push(s) : catSegs.push(s);
            }
        });

        for (const p of [...catSegs].sort((a, b) => a.split('.').length - b.split('.').length)) {
            await expandPath(p);
        }

        convListSegs.forEach(key => {
            const det = pathMap.get(key);
            if (det) det.open = true;
        });

        if (convSeg) {
            const [, path, idx] = convSeg.split('!');
            await expandPath(path);
            const det = pathMap.get(path);
            treeNavArr = det.__convs;
            treeRootConvs = det.__rootConvs;
            curItem = idx;

            selResults = [];
            if (det && det.__convs) openConversation(det.__convs[+idx], split(path), +idx, det.__rootConvs);
        } else closeConversation();
        modifyHashAllowed = true;

        /* ---------- facet (plotSelect) ---------- */
        if (facetTok) {
            const facetName = decodeURIComponent(facetTok.slice(3));
            if (plotSelect.value !== facetName && facetOptions.has(facetName)) {
                plotSelect.value = facetName;
                await loadDraw(facetOptions.get(facetName)); // loads points for that facet
            }
        }
        /* ---------- restore marquee & selection list ---------- */
        if (!convSeg && rectTok) {
            // we do floats so difference canvas width and height are preserved
            const [nx1, ny1, nx2, ny2] = rectTok.slice(2).split('=').map(parseFloat);
            const w = plotCanvas.width,
                h = plotCanvas.height;
            const minX = nx1 * w,
                minY = ny1 * h,
                maxX = nx2 * w,
                maxY = ny2 * h;
            selRect = {
                minX,
                maxX,
                minY,
                maxY
            };
            const idxs = getPointIndicesInRect(minX, maxX, minY, maxY);
            const mapping = conversationsMappings.get(plotSelect.value);
            selResults = idxs.map(i => ({
                fileI: mapping.indices[i][0],
                itemI: mapping.indices[i][1]
            }));

            curPage = pageTok ? +pageTok.slice(2) : 0;
            selPane.classList.remove('hidden');
            plotWrap.classList.add('smol');
            drawPoints();
            showTree(false);
            showTreeToggle(true);
            await renderSelPage(true);
        }

        /* ---------- optionally reopen the modal ---------- */
        if (!convSeg && selConvTok) {
            const [f, i] = selConvTok.slice(2).split('.').map(Number);
            loadAndShowConversation(f, i); // uses spinner, keeps state
        }

    } finally {
        loading.classList.add('hidden'); // ‚ë† show spinner
    }

}


/* return the cached array for that data file or undefined     */
function cachedConvs(fileURL) {
    return loadAndShowConversation.cache ?
        loadAndShowConversation.cache.get(fileURL) :
        undefined;
}

var alreadyProcessed = new Set();

var labelFrequencies = new Map();

/* try to replace the label of one <button>                    */
function maybeUpdateLabel(btn) {
    const fileI = +btn.dataset.f,
        itemI = +btn.dataset.i,
        mapping = conversationsMappings.get(plotSelect.value),
        fileURL = `${mapping.baseUrl}data${fileI}.json.gz`,
        convArr = cachedConvs(fileURL);

    if (convArr) {
        const cv = convArr[itemI];
        const label = cv.facetValue || // in our datasets
            cv.allFacetValues?.[0]?.value; // fall-back
        if (label) btn.textContent = label;
    }
}

// from https://gist.github.com/sebleier/554280
commons = "i,me,my,myself,we,our,ours,ourselves,you,your,yours,yourself,yourselves,he,him,his,himself,she,her,hers,herself,it,its,itself,they,them,their,theirs,themselves,what,which,who,whom,this,that,these,those,am,is,are,was,were,be,been,being,have,has,had,having,do,does,did,doing,a,an,the,and,but,if,or,because,as,until,while,of,at,by,for,with,about,against,between,into,through,during,before,after,above,below,to,from,up,down,in,out,on,off,over,under,again,further,then,once,here,there,when,where,why,how,all,any,both,each,few,more,most,other,some,such,no,nor,not,only,own,same,so,than,too,very,s,t,can,will,just,don,should,now".split(",")

var commonWords = new Set();
for (const common of commons) {
    commonWords.add(common);
}

var numUnloaded = 0;
/* try to replace the label of one <button>                    */
function storeFrequencies() {
    var mapping = conversationsMappings.get(plotSelect.value);
    var newFiles = new Set();
    var unloadedFiles = new Set();
    numUnloaded = 0;
    for (const i of selResults) {
        if (alreadyProcessed.has(i.fileI)) {
            continue;
        }
        var fileI = i.fileI;
        var itemI = i.itemI;
        var fileURL = `${mapping.baseUrl}data${fileI}.json.gz`;
        var convArr = cachedConvs(fileURL);
        var label = "<unloaded>";
        if (convArr) {
            const cv = convArr[itemI];
            label = cv.facetValue || // in our datasets
                cv.allFacetValues?.[0]?.value; // fall-back
            newFiles.add(i.fileI);
            if (!labelFrequencies.has(label)) {
                labelFrequencies.set(label, 0);
            }
            labelFrequencies.set(label, labelFrequencies.get(label) + 1);


            // if raw embeddings, do word cloud over conversation contents
            if (plotSelect.value === RAW_EMBEDDING_NAME) {
                const cv = convArr[itemI];
                var convStr = [];
                for (const turn of cv.conversation) {
                    convStr.push(turn.content);
                }
                label = convStr.join(" ").replace("\n", " ").replace("\r", " ").replace("\t", " ");
            }

            for (const word of splitIntoWords(label)) {
                var wordLower = word.toLowerCase();
                if (commonWords.has(wordLower)) continue;
                if (!wordFrequencies.has(wordLower)) {
                    wordFrequencies.set(wordLower, 0);
                }
                wordFrequencies.set(wordLower, wordFrequencies.get(wordLower) + 1);
            }
        } else {
            unloadedFiles.add(i.fileI);
            numUnloaded += 1;
        }
    }
    for (var newFile of newFiles) {
        alreadyProcessed.add(newFile);
    }

    if (unloadedFiles.size > 0) {
        console.log("unloaded files");
        console.log(unloadedFiles);
        loadAllBtn.textContent = "Load all (" + numUnloaded + " conversations within " + unloadedFiles.size + " files)";
    } else {
        loadAllBtnSpace.classList.add("hidden");
    }

    labelFrequencies.set("<unloaded>", numUnloaded);
}

function renderFrequencies() {
    /* create the box once */
    let box = document.getElementById('freqBox');
    if (!box) {
        box = document.createElement('div');
        box.id = 'freqBox';
        selPane.appendChild(box);
    }

    /* sort by descending count */
    const rows = [...labelFrequencies.entries()]
        .sort((a, b) => b[1] - a[1])
        .slice(0, 100); // top-100;

    /* build chips */
    box.innerHTML = "";
    for (const [label, count] of rows) {
        const chip = document.createElement('span');
        chip.className = 'freqChip';
        chip.textContent = `${label} (${count})`;
        box.appendChild(chip);
    }
}

function splitIntoWords(s) {
    return s.split(/[^\p{L}\p{N}\p{Extended_Pictographic}]+/u).filter(subStr => subStr.length > 0);
}


var wordFrequencies = new Map();

function buildWordCloud() {
    // Bail out if library not loaded
    if (typeof WordCloud === 'undefined') return;

    var unloadedStr = numUnloaded != 0 ? ("(" + numUnloaded + " not loaded yet and ignored, please page over to them)") : "(all loaded)";
    wordCloudTitle.textContent = "Selected Conversations' " + (plotSelect.value == RAW_EMBEDDING_NAME ? "Text" : plotSelect.value) + " Word Cloud " + unloadedStr;

    // 1.  Take the 100 most frequent labels
    const rows = [...wordFrequencies.entries()]
        .sort((a, b) => b[1] - a[1])
        .slice(0, 100);

    var total = 0;
    for (var vals of rows) {
        total += vals[1];
    }

    // need to normalize or they get too big
    // 2.  Convert to the ‚Äúlist‚Äù format WordCloud expects
    //     [ [word, weight], ‚Ä¶ ]
    const wcList = rows.map(([label, count]) => [label, 100 * count / total]);

    // 3.  Draw
    const canvas = document.getElementById('wcCanvas');
    WordCloud(canvas, {
        list: wcList,
        weightFactor: 10, // tweak size scaling
        minSize: 8, // smallest font (px)
        backgroundColor: 'rgba(0,0,0,0)', // keep site bg
        color: (_, weight) => weight > rows[0][1] * 0.6 ? '#6ec1ff' : weight > rows[0][1] * 0.3 ? '#74b9ff' : '#9e9e9e',
        rotateRatio: 0.15, // few words angled
        shuffle: false, // heavier words first
        origin: [canvas.width / 2, canvas.height / 2],
        drawOutOfBound: false
    });
}




function hasConvArrayLoaded(fileI) {
    const mapping = conversationsMappings.get(plotSelect.value);
    const fileURL = `${mapping.baseUrl}data${fileI}.json.gz`;

    if (!loadAndShowConversation.cache)
        loadAndShowConversation.cache = new Map();

    return loadAndShowConversation.cache.has(fileURL);
}

async function getConvArray(fileI) {
    const mapping = conversationsMappings.get(plotSelect.value);
    const fileURL = `${mapping.baseUrl}data${fileI}.json.gz`;

    if (!loadAndShowConversation.cache)
        loadAndShowConversation.cache = new Map();

    let arr = loadAndShowConversation.cache.get(fileURL);
    if (!arr) {
        arr = PASSWORD_PROTECTED ?
            (await decryptPasswordProtectedFile(fileURL)).conversationsData :
            (await fetchJsonGz(fileURL)).conversationsData;
        loadAndShowConversation.cache.set(fileURL, arr);
    }
    return arr;
}

loadAllBtn.onclick = preloadAllSelectedFiles;
async function preloadAllSelectedFiles() {
    if (!selResults.length) return;

    loading.classList.remove('hidden');
    setLoad('loading files ‚Ä¶ 0/0');

    /* build unique file-id list */
    const fileSet = new Set(selResults.map(r => r.fileI).filter(fileI => !hasConvArrayLoaded(fileI)));

    let done = 0;
    for (const fileI of fileSet) {
        await getConvArray(fileI); // already cached? ‚Üí returns instantly
        setLoad(`loading files ‚Ä¶ ${++done}/${fileSet.size}`);
    }

    /* now every conversation is in RAM ‚Üí update labels & chips */
    await renderSelPage(false);

    loading.classList.add('hidden');

}

async function preloadCurrentPage(alreadyLoading) {

    if (!alreadyLoading) loading.classList.remove('hidden');
    setLoad('loading files‚Ä¶');
    try {


        const total = selResults.length;
        const pages = Math.ceil(total / PAGE_SIZE) || 1;

        // clamp page index
        curPage = Math.min(Math.max(curPage, 0), pages - 1);

        // slice rows for this page
        const start = curPage * PAGE_SIZE;

        const rows = selResults.slice(start, start + PAGE_SIZE);
        // only load ones we haven't already loaded
        const fileSet = new Set(rows.map(({
            fileI,
            itemI
        }) => fileI).filter(fileI => !hasConvArrayLoaded(fileI)));
        var i = 0;
        for (var fileId of fileSet) {
            await getConvArray(fileId);
            setLoad(`loading files ‚Ä¶ ${i+1}/${fileSet.size}`);
            i += 1;
        }

    } finally {
        if (!alreadyLoading) loading.classList.add('hidden');
    }
}


/*!
 LZ-UTF8 v0.5.7

 Copyright (c) 2018, Rotem Dan
 Released under the MIT license.

 Build date: 2021-01-12 

 Please report any issue at https://github.com/rotemdan/lzutf8.js/issues
*/
var IE10SubarrayBugPatcher,LZUTF8;!function(e){e.runningInNodeJS=function(){return"object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node},e.runningInMainNodeJSModule=function(){return e.runningInNodeJS()&&require.main===module},e.commonJSAvailable=function(){return"object"==typeof module&&"object"==typeof module.exports},e.runningInWebWorker=function(){return"undefined"==typeof window&&"object"==typeof self&&"function"==typeof self.addEventListener&&"function"==typeof self.close},e.runningInNodeChildProcess=function(){return e.runningInNodeJS()&&"function"==typeof process.send},e.runningInNullOrigin=function(){return"object"==typeof window&&"object"==typeof window.location&&"object"==typeof document&&("http:"!==document.location.protocol&&"https:"!==document.location.protocol)},e.webWorkersAvailable=function(){return"function"==typeof Worker&&!e.runningInNullOrigin()&&(!e.runningInNodeJS()&&!(navigator&&navigator.userAgent&&navigator.userAgent.indexOf("Android 4.3")>=0))},e.log=function(e,t){void 0===t&&(t=!1),"object"==typeof console&&(console.log(e),t&&"object"==typeof document&&(document.body.innerHTML+=e+"<br/>"))},e.createErrorMessage=function(t,n){if(void 0===n&&(n="Unhandled exception"),null==t)return n;if(n+=": ","object"==typeof t.content){if(e.runningInNodeJS())return n+t.content.stack;var r=JSON.stringify(t.content);return"{}"!==r?n+r:n+t.content}return"string"==typeof t.content?n+t.content:n+t},e.printExceptionAndStackTraceToConsole=function(t,n){void 0===n&&(n="Unhandled exception"),e.log(e.createErrorMessage(t,n))},e.getGlobalObject=function(){return"object"==typeof global?global:"object"==typeof window?window:"object"==typeof self?self:{}},e.toString=Object.prototype.toString,e.commonJSAvailable()&&(module.exports=e)}(LZUTF8||(LZUTF8={})),function(e){if("function"==typeof Uint8Array&&0!==new Uint8Array(1).subarray(1).byteLength){var t=function(e,t){var n=function(e,t,n){return e<t?t:e>n?n:e};e|=0,t|=0,arguments.length<1&&(e=0),arguments.length<2&&(t=this.length),e<0&&(e=this.length+e),t<0&&(t=this.length+t),e=n(e,0,this.length);var r=(t=n(t,0,this.length))-e;return r<0&&(r=0),new this.constructor(this.buffer,this.byteOffset+e*this.BYTES_PER_ELEMENT,r)},n=["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array"],r=void 0;if("object"==typeof window?r=window:"object"==typeof self&&(r=self),void 0!==r)for(var o=0;o<n.length;o++)r[n[o]]&&(r[n[o]].prototype.subarray=t)}}(IE10SubarrayBugPatcher||(IE10SubarrayBugPatcher={})),function(e){var t=function(){function t(){}return t.compressAsync=function(t,n,r){var o=new e.Timer,i=new e.Compressor;if(!r)throw new TypeError("compressAsync: No callback argument given");if("string"==typeof t)t=e.encodeUTF8(t);else if(null==t||!(t instanceof Uint8Array))return void r(void 0,new TypeError("compressAsync: Invalid input argument, only 'string' and 'Uint8Array' are supported"));var u=e.ArrayTools.splitByteArray(t,n.blockSize),s=[],a=function(t){if(t<u.length){var c=void 0;try{c=i.compressBlock(u[t])}catch(e){return void r(void 0,e)}s.push(c),o.getElapsedTime()<=20?a(t+1):(e.enqueueImmediate((function(){return a(t+1)})),o.restart())}else{var f=e.ArrayTools.concatUint8Arrays(s);e.enqueueImmediate((function(){var t;try{t=e.CompressionCommon.encodeCompressedBytes(f,n.outputEncoding)}catch(e){return void r(void 0,e)}e.enqueueImmediate((function(){return r(t)}))}))}};e.enqueueImmediate((function(){return a(0)}))},t.createCompressionStream=function(){var t=new e.Compressor,n=new(require("readable-stream").Transform)({decodeStrings:!0,highWaterMark:65536});return n._transform=function(r,o,i){var u;try{u=e.BufferTools.uint8ArrayToBuffer(t.compressBlock(e.BufferTools.bufferToUint8Array(r)))}catch(e){return void n.emit("error",e)}n.push(u),i()},n},t}();e.AsyncCompressor=t}(LZUTF8||(LZUTF8={})),function(e){var t=function(){function t(){}return t.decompressAsync=function(t,n,r){if(!r)throw new TypeError("decompressAsync: No callback argument given");var o=new e.Timer;try{t=e.CompressionCommon.decodeCompressedBytes(t,n.inputEncoding)}catch(e){return void r(void 0,e)}var i=new e.Decompressor,u=e.ArrayTools.splitByteArray(t,n.blockSize),s=[],a=function(t){if(t<u.length){var c=void 0;try{c=i.decompressBlock(u[t])}catch(e){return void r(void 0,e)}s.push(c),o.getElapsedTime()<=20?a(t+1):(e.enqueueImmediate((function(){return a(t+1)})),o.restart())}else{var f=e.ArrayTools.concatUint8Arrays(s);e.enqueueImmediate((function(){var t;try{t=e.CompressionCommon.encodeDecompressedBytes(f,n.outputEncoding)}catch(e){return void r(void 0,e)}e.enqueueImmediate((function(){return r(t)}))}))}};e.enqueueImmediate((function(){return a(0)}))},t.createDecompressionStream=function(){var t=new e.Decompressor,n=new(require("readable-stream").Transform)({decodeStrings:!0,highWaterMark:65536});return n._transform=function(r,o,i){var u;try{u=e.BufferTools.uint8ArrayToBuffer(t.decompressBlock(e.BufferTools.bufferToUint8Array(r)))}catch(e){return void n.emit("error",e)}n.push(u),i()},n},t}();e.AsyncDecompressor=t}(LZUTF8||(LZUTF8={})),function(e){var t;!function(t){t.compressAsync=function(e,n,r){if("ByteArray"!=n.inputEncoding||e instanceof Uint8Array){var o={token:Math.random().toString(),type:"compress",data:e,inputEncoding:n.inputEncoding,outputEncoding:n.outputEncoding},i=function(e){var n=e.data;n&&n.token==o.token&&(t.globalWorker.removeEventListener("message",i),"error"==n.type?r(void 0,new Error(n.error)):r(n.data))};t.globalWorker.addEventListener("message",i),t.globalWorker.postMessage(o,[])}else r(void 0,new TypeError("compressAsync: input is not a Uint8Array"))},t.decompressAsync=function(e,n,r){var o={token:Math.random().toString(),type:"decompress",data:e,inputEncoding:n.inputEncoding,outputEncoding:n.outputEncoding},i=function(e){var n=e.data;n&&n.token==o.token&&(t.globalWorker.removeEventListener("message",i),"error"==n.type?r(void 0,new Error(n.error)):r(n.data))};t.globalWorker.addEventListener("message",i),t.globalWorker.postMessage(o,[])},t.installWebWorkerIfNeeded=function(){"object"==typeof self&&void 0===self.document&&null!=self.addEventListener&&(self.addEventListener("message",(function(t){var n=t.data;if("compress"==n.type){var r=void 0;try{r=e.compress(n.data,{outputEncoding:n.outputEncoding})}catch(t){return void self.postMessage({token:n.token,type:"error",error:e.createErrorMessage(t)},[])}(o={token:n.token,type:"compressionResult",data:r,encoding:n.outputEncoding}).data instanceof Uint8Array&&-1===navigator.appVersion.indexOf("MSIE 10")?self.postMessage(o,[o.data.buffer]):self.postMessage(o,[])}else if("decompress"==n.type){var o,i=void 0;try{i=e.decompress(n.data,{inputEncoding:n.inputEncoding,outputEncoding:n.outputEncoding})}catch(t){return void self.postMessage({token:n.token,type:"error",error:e.createErrorMessage(t)},[])}(o={token:n.token,type:"decompressionResult",data:i,encoding:n.outputEncoding}).data instanceof Uint8Array&&-1===navigator.appVersion.indexOf("MSIE 10")?self.postMessage(o,[o.data.buffer]):self.postMessage(o,[])}})),self.addEventListener("error",(function(t){e.log(e.createErrorMessage(t.error,"Unexpected LZUTF8 WebWorker exception"))})))},t.createGlobalWorkerIfNeeded=function(){if(t.globalWorker)return!0;if(!e.webWorkersAvailable())return!1;if(!t.scriptURI&&"object"==typeof document){var n=document.getElementById("lzutf8");null!=n&&(t.scriptURI=n.getAttribute("src")||void 0)}return!!t.scriptURI&&(t.globalWorker=new Worker(t.scriptURI),!0)},t.terminate=function(){t.globalWorker&&(t.globalWorker.terminate(),t.globalWorker=void 0)}}(t=e.WebWorker||(e.WebWorker={})),t.installWebWorkerIfNeeded()}(LZUTF8||(LZUTF8={})),function(e){var t=function(){function e(e,t,n){this.container=e,this.startPosition=t,this.length=n}return e.prototype.get=function(e){return this.container[this.startPosition+e]},e.prototype.getInReversedOrder=function(e){return this.container[this.startPosition+this.length-1-e]},e.prototype.set=function(e,t){this.container[this.startPosition+e]=t},e}();e.ArraySegment=t}(LZUTF8||(LZUTF8={})),function(e){!function(e){e.copyElements=function(e,t,n,r,o){for(;o--;)n[r++]=e[t++]},e.zeroElements=function(e,t,n){for(;n--;)e[t++]=0},e.countNonzeroValuesInArray=function(e){for(var t=0,n=0;n<e.length;n++)e[n]&&t++;return t},e.truncateStartingElements=function(e,t){if(e.length<=t)throw new RangeError("truncateStartingElements: Requested length should be smaller than array length");for(var n=e.length-t,r=0;r<t;r++)e[r]=e[n+r];e.length=t},e.doubleByteArrayCapacity=function(e){var t=new Uint8Array(2*e.length);return t.set(e),t},e.concatUint8Arrays=function(e){for(var t=0,n=0,r=e;n<r.length;n++){t+=(a=r[n]).length}for(var o=new Uint8Array(t),i=0,u=0,s=e;u<s.length;u++){var a=s[u];o.set(a,i),i+=a.length}return o},e.splitByteArray=function(e,t){for(var n=[],r=0;r<e.length;){var o=Math.min(t,e.length-r);n.push(e.subarray(r,r+o)),r+=o}return n}}(e.ArrayTools||(e.ArrayTools={}))}(LZUTF8||(LZUTF8={})),function(e){!function(e){e.convertToUint8ArrayIfNeeded=function(t){return"function"==typeof Buffer&&Buffer.isBuffer(t)?e.bufferToUint8Array(t):t},e.uint8ArrayToBuffer=function(e){if(Buffer.prototype instanceof Uint8Array){var t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);return Object.setPrototypeOf(t,Buffer.prototype),t}for(var n=e.length,r=new Buffer(n),o=0;o<n;o++)r[o]=e[o];return r},e.bufferToUint8Array=function(e){if(Buffer.prototype instanceof Uint8Array)return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(var t=e.length,n=new Uint8Array(t),r=0;r<t;r++)n[r]=e[r];return n}}(e.BufferTools||(e.BufferTools={}))}(LZUTF8||(LZUTF8={})),function(e){!function(t){t.getCroppedBuffer=function(e,t,n,r){void 0===r&&(r=0);var o=new Uint8Array(n+r);return o.set(e.subarray(t,t+n)),o},t.getCroppedAndAppendedByteArray=function(t,n,r,o){return e.ArrayTools.concatUint8Arrays([t.subarray(n,n+r),o])},t.detectCompressionSourceEncoding=function(e){if(null==e)throw new TypeError("detectCompressionSourceEncoding: input is null or undefined");if("string"==typeof e)return"String";if(e instanceof Uint8Array||"function"==typeof Buffer&&Buffer.isBuffer(e))return"ByteArray";throw new TypeError("detectCompressionSourceEncoding: input must be of type 'string', 'Uint8Array' or 'Buffer'")},t.encodeCompressedBytes=function(t,n){switch(n){case"ByteArray":return t;case"Buffer":return e.BufferTools.uint8ArrayToBuffer(t);case"Base64":return e.encodeBase64(t);case"BinaryString":return e.encodeBinaryString(t);case"StorageBinaryString":return e.encodeStorageBinaryString(t);default:throw new TypeError("encodeCompressedBytes: invalid output encoding requested")}},t.decodeCompressedBytes=function(t,n){if(null==n)throw new TypeError("decodeCompressedData: Input is null or undefined");switch(n){case"ByteArray":case"Buffer":var r=e.BufferTools.convertToUint8ArrayIfNeeded(t);if(!(r instanceof Uint8Array))throw new TypeError("decodeCompressedData: 'ByteArray' or 'Buffer' input type was specified but input is not a Uint8Array or Buffer");return r;case"Base64":if("string"!=typeof t)throw new TypeError("decodeCompressedData: 'Base64' input type was specified but input is not a string");return e.decodeBase64(t);case"BinaryString":if("string"!=typeof t)throw new TypeError("decodeCompressedData: 'BinaryString' input type was specified but input is not a string");return e.decodeBinaryString(t);case"StorageBinaryString":if("string"!=typeof t)throw new TypeError("decodeCompressedData: 'StorageBinaryString' input type was specified but input is not a string");return e.decodeStorageBinaryString(t);default:throw new TypeError("decodeCompressedData: invalid input encoding requested: '"+n+"'")}},t.encodeDecompressedBytes=function(t,n){switch(n){case"String":return e.decodeUTF8(t);case"ByteArray":return t;case"Buffer":if("function"!=typeof Buffer)throw new TypeError("encodeDecompressedBytes: a 'Buffer' type was specified but is not supported at the current envirnment");return e.BufferTools.uint8ArrayToBuffer(t);default:throw new TypeError("encodeDecompressedBytes: invalid output encoding requested")}}}(e.CompressionCommon||(e.CompressionCommon={}))}(LZUTF8||(LZUTF8={})),function(e){var t;!function(t){var n,r=[];t.enqueueImmediate=function(e){r.push(e),1===r.length&&n()},t.initializeScheduler=function(){var t=function(){for(var t=0,n=r;t<n.length;t++){var o=n[t];try{o.call(void 0)}catch(t){e.printExceptionAndStackTraceToConsole(t,"enqueueImmediate exception")}}r.length=0};if(e.runningInNodeJS()&&(n=function(){return setImmediate((function(){return t()}))}),"object"==typeof window&&"function"==typeof window.addEventListener&&"function"==typeof window.postMessage){var o,i="enqueueImmediate-"+Math.random().toString();window.addEventListener("message",(function(e){e.data===i&&t()})),o=e.runningInNullOrigin()?"*":window.location.href,n=function(){return window.postMessage(i,o)}}else if("function"==typeof MessageChannel&&"function"==typeof MessagePort){var u=new MessageChannel;u.port1.onmessage=function(){return t()},n=function(){return u.port2.postMessage(0)}}else n=function(){return setTimeout((function(){return t()}),0)}},t.initializeScheduler()}(t=e.EventLoop||(e.EventLoop={})),e.enqueueImmediate=function(e){return t.enqueueImmediate(e)}}(LZUTF8||(LZUTF8={})),function(e){!function(e){e.override=function(t,n){return e.extend(t,n)},e.extend=function(e,t){if(null==e)throw new TypeError("obj is null or undefined");if("object"!=typeof e)throw new TypeError("obj is not an object");if(null==t&&(t={}),"object"!=typeof t)throw new TypeError("newProperties is not an object");if(null!=t)for(var n in t)e[n]=t[n];return e}}(e.ObjectTools||(e.ObjectTools={}))}(LZUTF8||(LZUTF8={})),function(e){e.getRandomIntegerInRange=function(e,t){return e+Math.floor(Math.random()*(t-e))},e.getRandomUTF16StringOfLength=function(t){for(var n="",r=0;r<t;r++){var o=void 0;do{o=e.getRandomIntegerInRange(0,1114112)}while(o>=55296&&o<=57343);n+=e.Encoding.CodePoint.decodeToString(o)}return n}}(LZUTF8||(LZUTF8={})),function(e){var t=function(){function e(e){void 0===e&&(e=1024),this.outputBufferCapacity=e,this.outputPosition=0,this.outputString="",this.outputBuffer=new Uint16Array(this.outputBufferCapacity)}return e.prototype.appendCharCode=function(e){this.outputBuffer[this.outputPosition++]=e,this.outputPosition===this.outputBufferCapacity&&this.flushBufferToOutputString()},e.prototype.appendCharCodes=function(e){for(var t=0,n=e.length;t<n;t++)this.appendCharCode(e[t])},e.prototype.appendString=function(e){for(var t=0,n=e.length;t<n;t++)this.appendCharCode(e.charCodeAt(t))},e.prototype.appendCodePoint=function(e){if(e<=65535)this.appendCharCode(e);else{if(!(e<=1114111))throw new Error("appendCodePoint: A code point of "+e+" cannot be encoded in UTF-16");this.appendCharCode(55296+(e-65536>>>10)),this.appendCharCode(56320+(e-65536&1023))}},e.prototype.getOutputString=function(){return this.flushBufferToOutputString(),this.outputString},e.prototype.flushBufferToOutputString=function(){this.outputPosition===this.outputBufferCapacity?this.outputString+=String.fromCharCode.apply(null,this.outputBuffer):this.outputString+=String.fromCharCode.apply(null,this.outputBuffer.subarray(0,this.outputPosition)),this.outputPosition=0},e}();e.StringBuilder=t}(LZUTF8||(LZUTF8={})),function(e){var t=function(){function t(){this.restart()}return t.prototype.restart=function(){this.startTime=t.getTimestamp()},t.prototype.getElapsedTime=function(){return t.getTimestamp()-this.startTime},t.prototype.getElapsedTimeAndRestart=function(){var e=this.getElapsedTime();return this.restart(),e},t.prototype.logAndRestart=function(t,n){void 0===n&&(n=!0);var r=this.getElapsedTime(),o=t+": "+r.toFixed(3)+"ms";return e.log(o,n),this.restart(),r},t.getTimestamp=function(){return this.timestampFunc||this.createGlobalTimestampFunction(),this.timestampFunc()},t.getMicrosecondTimestamp=function(){return Math.floor(1e3*t.getTimestamp())},t.createGlobalTimestampFunction=function(){if("object"==typeof process&&"function"==typeof process.hrtime){var e=0;this.timestampFunc=function(){var t=process.hrtime(),n=1e3*t[0]+t[1]/1e6;return e+n},e=Date.now()-this.timestampFunc()}else if("object"==typeof chrome&&chrome.Interval){var t=Date.now(),n=new chrome.Interval;n.start(),this.timestampFunc=function(){return t+n.microseconds()/1e3}}else if("object"==typeof performance&&performance.now){var r=Date.now()-performance.now();this.timestampFunc=function(){return r+performance.now()}}else Date.now?this.timestampFunc=function(){return Date.now()}:this.timestampFunc=function(){return(new Date).getTime()}},t}();e.Timer=t}(LZUTF8||(LZUTF8={})),function(e){var t=function(){function t(t){void 0===t&&(t=!0),this.MinimumSequenceLength=4,this.MaximumSequenceLength=31,this.MaximumMatchDistance=32767,this.PrefixHashTableSize=65537,this.inputBufferStreamOffset=1,t&&"function"==typeof Uint32Array?this.prefixHashTable=new e.CompressorCustomHashTable(this.PrefixHashTableSize):this.prefixHashTable=new e.CompressorSimpleHashTable(this.PrefixHashTableSize)}return t.prototype.compressBlock=function(t){if(null==t)throw new TypeError("compressBlock: undefined or null input received");return"string"==typeof t&&(t=e.encodeUTF8(t)),t=e.BufferTools.convertToUint8ArrayIfNeeded(t),this.compressUtf8Block(t)},t.prototype.compressUtf8Block=function(e){if(!e||0==e.length)return new Uint8Array(0);var t=this.cropAndAddNewBytesToInputBuffer(e),n=this.inputBuffer,r=this.inputBuffer.length;this.outputBuffer=new Uint8Array(e.length),this.outputBufferPosition=0;for(var o=0,i=t;i<r;i++){var u=n[i],s=i<o;if(i>r-this.MinimumSequenceLength)s||this.outputRawByte(u);else{var a=this.getBucketIndexForPrefix(i);if(!s){var c=this.findLongestMatch(i,a);null!=c&&(this.outputPointerBytes(c.length,c.distance),o=i+c.length,s=!0)}s||this.outputRawByte(u);var f=this.inputBufferStreamOffset+i;this.prefixHashTable.addValueToBucket(a,f)}}return this.outputBuffer.subarray(0,this.outputBufferPosition)},t.prototype.findLongestMatch=function(e,t){var n=this.prefixHashTable.getArraySegmentForBucketIndex(t,this.reusableArraySegmentObject);if(null==n)return null;for(var r,o=this.inputBuffer,i=0,u=0;u<n.length;u++){var s=n.getInReversedOrder(u)-this.inputBufferStreamOffset,a=e-s,c=void 0;if(c=void 0===r?this.MinimumSequenceLength-1:r<128&&a>=128?i+(i>>>1):i,a>this.MaximumMatchDistance||c>=this.MaximumSequenceLength||e+c>=o.length)break;if(o[s+c]===o[e+c])for(var f=0;;f++){if(e+f===o.length||o[s+f]!==o[e+f]){f>c&&(r=a,i=f);break}if(f===this.MaximumSequenceLength)return{distance:a,length:this.MaximumSequenceLength}}}return void 0!==r?{distance:r,length:i}:null},t.prototype.getBucketIndexForPrefix=function(e){return(7880599*this.inputBuffer[e]+39601*this.inputBuffer[e+1]+199*this.inputBuffer[e+2]+this.inputBuffer[e+3])%this.PrefixHashTableSize},t.prototype.outputPointerBytes=function(e,t){t<128?(this.outputRawByte(192|e),this.outputRawByte(t)):(this.outputRawByte(224|e),this.outputRawByte(t>>>8),this.outputRawByte(255&t))},t.prototype.outputRawByte=function(e){this.outputBuffer[this.outputBufferPosition++]=e},t.prototype.cropAndAddNewBytesToInputBuffer=function(t){if(void 0===this.inputBuffer)return this.inputBuffer=t,0;var n=Math.min(this.inputBuffer.length,this.MaximumMatchDistance),r=this.inputBuffer.length-n;return this.inputBuffer=e.CompressionCommon.getCroppedAndAppendedByteArray(this.inputBuffer,r,n,t),this.inputBufferStreamOffset+=r,n},t}();e.Compressor=t}(LZUTF8||(LZUTF8={})),function(e){var t=function(){function t(e){this.minimumBucketCapacity=4,this.maximumBucketCapacity=64,this.bucketLocators=new Uint32Array(2*e),this.storage=new Uint32Array(2*e),this.storageIndex=1}return t.prototype.addValueToBucket=function(t,n){t<<=1,this.storageIndex>=this.storage.length>>>1&&this.compact();var r,o=this.bucketLocators[t];if(0===o)o=this.storageIndex,r=1,this.storage[this.storageIndex]=n,this.storageIndex+=this.minimumBucketCapacity;else{(r=this.bucketLocators[t+1])===this.maximumBucketCapacity-1&&(r=this.truncateBucketToNewerElements(o,r,this.maximumBucketCapacity/2));var i=o+r;0===this.storage[i]?(this.storage[i]=n,i===this.storageIndex&&(this.storageIndex+=r)):(e.ArrayTools.copyElements(this.storage,o,this.storage,this.storageIndex,r),o=this.storageIndex,this.storageIndex+=r,this.storage[this.storageIndex++]=n,this.storageIndex+=r),r++}this.bucketLocators[t]=o,this.bucketLocators[t+1]=r},t.prototype.truncateBucketToNewerElements=function(t,n,r){var o=t+n-r;return e.ArrayTools.copyElements(this.storage,o,this.storage,t,r),e.ArrayTools.zeroElements(this.storage,t+r,n-r),r},t.prototype.compact=function(){var t=this.bucketLocators,n=this.storage;this.bucketLocators=new Uint32Array(this.bucketLocators.length),this.storageIndex=1;for(var r=0;r<t.length;r+=2){var o=t[r+1];0!==o&&(this.bucketLocators[r]=this.storageIndex,this.bucketLocators[r+1]=o,this.storageIndex+=Math.max(Math.min(2*o,this.maximumBucketCapacity),this.minimumBucketCapacity))}this.storage=new Uint32Array(8*this.storageIndex);for(r=0;r<t.length;r+=2){var i=t[r];if(0!==i){var u=this.bucketLocators[r],s=this.bucketLocators[r+1];e.ArrayTools.copyElements(n,i,this.storage,u,s)}}},t.prototype.getArraySegmentForBucketIndex=function(t,n){t<<=1;var r=this.bucketLocators[t];return 0===r?null:(void 0===n&&(n=new e.ArraySegment(this.storage,r,this.bucketLocators[t+1])),n)},t.prototype.getUsedBucketCount=function(){return Math.floor(e.ArrayTools.countNonzeroValuesInArray(this.bucketLocators)/2)},t.prototype.getTotalElementCount=function(){for(var e=0,t=0;t<this.bucketLocators.length;t+=2)e+=this.bucketLocators[t+1];return e},t}();e.CompressorCustomHashTable=t}(LZUTF8||(LZUTF8={})),function(e){var t=function(){function t(e){this.maximumBucketCapacity=64,this.buckets=new Array(e)}return t.prototype.addValueToBucket=function(t,n){var r=this.buckets[t];void 0===r?this.buckets[t]=[n]:(r.length===this.maximumBucketCapacity-1&&e.ArrayTools.truncateStartingElements(r,this.maximumBucketCapacity/2),r.push(n))},t.prototype.getArraySegmentForBucketIndex=function(t,n){var r=this.buckets[t];return void 0===r?null:(void 0===n&&(n=new e.ArraySegment(r,0,r.length)),n)},t.prototype.getUsedBucketCount=function(){return e.ArrayTools.countNonzeroValuesInArray(this.buckets)},t.prototype.getTotalElementCount=function(){for(var e=0,t=0;t<this.buckets.length;t++)void 0!==this.buckets[t]&&(e+=this.buckets[t].length);return e},t}();e.CompressorSimpleHashTable=t}(LZUTF8||(LZUTF8={})),function(e){var t=function(){function t(){this.MaximumMatchDistance=32767,this.outputPosition=0}return t.prototype.decompressBlockToString=function(t){return t=e.BufferTools.convertToUint8ArrayIfNeeded(t),e.decodeUTF8(this.decompressBlock(t))},t.prototype.decompressBlock=function(t){this.inputBufferRemainder&&(t=e.ArrayTools.concatUint8Arrays([this.inputBufferRemainder,t]),this.inputBufferRemainder=void 0);for(var n=this.cropOutputBufferToWindowAndInitialize(Math.max(4*t.length,1024)),r=0,o=t.length;r<o;r++){var i=t[r];if(i>>>6==3){var u=i>>>5;if(r==o-1||r==o-2&&7==u){this.inputBufferRemainder=t.subarray(r);break}if(t[r+1]>>>7==1)this.outputByte(i);else{var s=31&i,a=void 0;6==u?(a=t[r+1],r+=1):(a=t[r+1]<<8|t[r+2],r+=2);for(var c=this.outputPosition-a,f=0;f<s;f++)this.outputByte(this.outputBuffer[c+f])}}else this.outputByte(i)}return this.rollBackIfOutputBufferEndsWithATruncatedMultibyteSequence(),e.CompressionCommon.getCroppedBuffer(this.outputBuffer,n,this.outputPosition-n)},t.prototype.outputByte=function(t){this.outputPosition===this.outputBuffer.length&&(this.outputBuffer=e.ArrayTools.doubleByteArrayCapacity(this.outputBuffer)),this.outputBuffer[this.outputPosition++]=t},t.prototype.cropOutputBufferToWindowAndInitialize=function(t){if(!this.outputBuffer)return this.outputBuffer=new Uint8Array(t),0;var n=Math.min(this.outputPosition,this.MaximumMatchDistance);if(this.outputBuffer=e.CompressionCommon.getCroppedBuffer(this.outputBuffer,this.outputPosition-n,n,t),this.outputPosition=n,this.outputBufferRemainder){for(var r=0;r<this.outputBufferRemainder.length;r++)this.outputByte(this.outputBufferRemainder[r]);this.outputBufferRemainder=void 0}return n},t.prototype.rollBackIfOutputBufferEndsWithATruncatedMultibyteSequence=function(){for(var e=1;e<=4&&this.outputPosition-e>=0;e++){var t=this.outputBuffer[this.outputPosition-e];if(e<4&&t>>>3==30||e<3&&t>>>4==14||e<2&&t>>>5==6)return this.outputBufferRemainder=this.outputBuffer.subarray(this.outputPosition-e,this.outputPosition),void(this.outputPosition-=e)}},t}();e.Decompressor=t}(LZUTF8||(LZUTF8={})),function(e){!function(t){!function(t){var n=new Uint8Array([65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,48,49,50,51,52,53,54,55,56,57,43,47]),r=new Uint8Array([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,62,255,255,255,63,52,53,54,55,56,57,58,59,60,61,255,255,255,0,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255,255,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,255,255,255,255]);t.encode=function(n){return n&&0!=n.length?e.runningInNodeJS()?e.BufferTools.uint8ArrayToBuffer(n).toString("base64"):t.encodeWithJS(n):""},t.decode=function(n){return n?e.runningInNodeJS()?e.BufferTools.bufferToUint8Array(new Buffer(n,"base64")):t.decodeWithJS(n):new Uint8Array(0)},t.encodeWithJS=function(t,r){if(void 0===r&&(r=!0),!t||0==t.length)return"";for(var o,i=n,u=new e.StringBuilder,s=0,a=t.length;s<a;s+=3)s<=a-3?(o=t[s]<<16|t[s+1]<<8|t[s+2],u.appendCharCode(i[o>>>18&63]),u.appendCharCode(i[o>>>12&63]),u.appendCharCode(i[o>>>6&63]),u.appendCharCode(i[63&o]),o=0):s===a-2?(o=t[s]<<16|t[s+1]<<8,u.appendCharCode(i[o>>>18&63]),u.appendCharCode(i[o>>>12&63]),u.appendCharCode(i[o>>>6&63]),r&&u.appendCharCode(61)):s===a-1&&(o=t[s]<<16,u.appendCharCode(i[o>>>18&63]),u.appendCharCode(i[o>>>12&63]),r&&(u.appendCharCode(61),u.appendCharCode(61)));return u.getOutputString()},t.decodeWithJS=function(e,t){if(!e||0==e.length)return new Uint8Array(0);var n=e.length%4;if(1===n)throw new Error("Invalid Base64 string: length % 4 == 1");2===n?e+="==":3===n&&(e+="="),t||(t=new Uint8Array(e.length));for(var o=0,i=e.length,u=0;u<i;u+=4){var s=r[e.charCodeAt(u)]<<18|r[e.charCodeAt(u+1)]<<12|r[e.charCodeAt(u+2)]<<6|r[e.charCodeAt(u+3)];t[o++]=s>>>16&255,t[o++]=s>>>8&255,t[o++]=255&s}return 61==e.charCodeAt(i-1)&&o--,61==e.charCodeAt(i-2)&&o--,t.subarray(0,o)}}(t.Base64||(t.Base64={}))}(e.Encoding||(e.Encoding={}))}(LZUTF8||(LZUTF8={})),function(e){!function(t){!function(t){t.encode=function(t){if(null==t)throw new TypeError("BinaryString.encode: undefined or null input received");if(0===t.length)return"";for(var n=t.length,r=new e.StringBuilder,o=0,i=1,u=0;u<n;u+=2){var s=void 0;s=u==n-1?t[u]<<8:t[u]<<8|t[u+1],r.appendCharCode(o<<16-i|s>>>i),o=s&(1<<i)-1,15===i?(r.appendCharCode(o),o=0,i=1):i+=1,u>=n-2&&r.appendCharCode(o<<16-i)}return r.appendCharCode(32768|n%2),r.getOutputString()},t.decode=function(e){if("string"!=typeof e)throw new TypeError("BinaryString.decode: invalid input type");if(""==e)return new Uint8Array(0);for(var t=new Uint8Array(3*e.length),n=0,r=function(e){t[n++]=e>>>8,t[n++]=255&e},o=0,i=0,u=0;u<e.length;u++){var s=e.charCodeAt(u);s>=32768?(32769==s&&n--,i=0):(0==i?o=s:(r(o<<i|s>>>15-i),o=s&(1<<15-i)-1),15==i?i=0:i+=1)}return t.subarray(0,n)}}(t.BinaryString||(t.BinaryString={}))}(e.Encoding||(e.Encoding={}))}(LZUTF8||(LZUTF8={})),function(e){!function(e){!function(e){e.encodeFromString=function(e,t){var n=e.charCodeAt(t);if(n<55296||n>56319)return n;var r=e.charCodeAt(t+1);if(r>=56320&&r<=57343)return r-56320+(n-55296<<10)+65536;throw new Error("getUnicodeCodePoint: Received a lead surrogate character, char code "+n+", followed by "+r+", which is not a trailing surrogate character code.")},e.decodeToString=function(e){if(e<=65535)return String.fromCharCode(e);if(e<=1114111)return String.fromCharCode(55296+(e-65536>>>10),56320+(e-65536&1023));throw new Error("getStringFromUnicodeCodePoint: A code point of "+e+" cannot be encoded in UTF-16")}}(e.CodePoint||(e.CodePoint={}))}(e.Encoding||(e.Encoding={}))}(LZUTF8||(LZUTF8={})),function(e){!function(e){!function(e){var t=["000","001","002","003","004","005","006","007","008","009","010","011","012","013","014","015","016","017","018","019","020","021","022","023","024","025","026","027","028","029","030","031","032","033","034","035","036","037","038","039","040","041","042","043","044","045","046","047","048","049","050","051","052","053","054","055","056","057","058","059","060","061","062","063","064","065","066","067","068","069","070","071","072","073","074","075","076","077","078","079","080","081","082","083","084","085","086","087","088","089","090","091","092","093","094","095","096","097","098","099","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255"];e.encode=function(e){for(var n=[],r=0;r<e.length;r++)n.push(t[e[r]]);return n.join(" ")}}(e.DecimalString||(e.DecimalString={}))}(e.Encoding||(e.Encoding={}))}(LZUTF8||(LZUTF8={})),function(e){!function(e){!function(t){t.encode=function(t){return e.BinaryString.encode(t).replace(/\0/g,"ËÄÇ")},t.decode=function(t){return e.BinaryString.decode(t.replace(/\u8002/g,"\0"))}}(e.StorageBinaryString||(e.StorageBinaryString={}))}(e.Encoding||(e.Encoding={}))}(LZUTF8||(LZUTF8={})),function(e){!function(t){!function(n){var r,o;n.encode=function(t){return t&&0!=t.length?e.runningInNodeJS()?e.BufferTools.bufferToUint8Array(new Buffer(t,"utf8")):n.createNativeTextEncoderAndDecoderIfAvailable()?r.encode(t):n.encodeWithJS(t):new Uint8Array(0)},n.decode=function(t){return t&&0!=t.length?e.runningInNodeJS()?e.BufferTools.uint8ArrayToBuffer(t).toString("utf8"):n.createNativeTextEncoderAndDecoderIfAvailable()?o.decode(t):n.decodeWithJS(t):""},n.encodeWithJS=function(e,n){if(!e||0==e.length)return new Uint8Array(0);n||(n=new Uint8Array(4*e.length));for(var r=0,o=0;o<e.length;o++){var i=t.CodePoint.encodeFromString(e,o);if(i<=127)n[r++]=i;else if(i<=2047)n[r++]=192|i>>>6,n[r++]=128|63&i;else if(i<=65535)n[r++]=224|i>>>12,n[r++]=128|i>>>6&63,n[r++]=128|63&i;else{if(!(i<=1114111))throw new Error("Invalid UTF-16 string: Encountered a character unsupported by UTF-8/16 (RFC 3629)");n[r++]=240|i>>>18,n[r++]=128|i>>>12&63,n[r++]=128|i>>>6&63,n[r++]=128|63&i,o++}}return n.subarray(0,r)},n.decodeWithJS=function(t,n,r){if(void 0===n&&(n=0),!t||0==t.length)return"";void 0===r&&(r=t.length);for(var o,i,u=new e.StringBuilder,s=n,a=r;s<a;){if((i=t[s])>>>7==0)o=i,s+=1;else if(i>>>5==6){if(s+1>=r)throw new Error("Invalid UTF-8 stream: Truncated codepoint sequence encountered at position "+s);o=(31&i)<<6|63&t[s+1],s+=2}else if(i>>>4==14){if(s+2>=r)throw new Error("Invalid UTF-8 stream: Truncated codepoint sequence encountered at position "+s);o=(15&i)<<12|(63&t[s+1])<<6|63&t[s+2],s+=3}else{if(i>>>3!=30)throw new Error("Invalid UTF-8 stream: An invalid lead byte value encountered at position "+s);if(s+3>=r)throw new Error("Invalid UTF-8 stream: Truncated codepoint sequence encountered at position "+s);o=(7&i)<<18|(63&t[s+1])<<12|(63&t[s+2])<<6|63&t[s+3],s+=4}u.appendCodePoint(o)}return u.getOutputString()},n.createNativeTextEncoderAndDecoderIfAvailable=function(){return!!r||"function"==typeof TextEncoder&&(r=new TextEncoder("utf-8"),o=new TextDecoder("utf-8"),!0)}}(t.UTF8||(t.UTF8={}))}(e.Encoding||(e.Encoding={}))}(LZUTF8||(LZUTF8={})),function(e){e.compress=function(t,n){if(void 0===n&&(n={}),null==t)throw new TypeError("compress: undefined or null input received");var r=e.CompressionCommon.detectCompressionSourceEncoding(t);n=e.ObjectTools.override({inputEncoding:r,outputEncoding:"ByteArray"},n);var o=(new e.Compressor).compressBlock(t);return e.CompressionCommon.encodeCompressedBytes(o,n.outputEncoding)},e.decompress=function(t,n){if(void 0===n&&(n={}),null==t)throw new TypeError("decompress: undefined or null input received");n=e.ObjectTools.override({inputEncoding:"ByteArray",outputEncoding:"String"},n);var r=e.CompressionCommon.decodeCompressedBytes(t,n.inputEncoding),o=(new e.Decompressor).decompressBlock(r);return e.CompressionCommon.encodeDecompressedBytes(o,n.outputEncoding)},e.compressAsync=function(t,n,r){var o;null==r&&(r=function(){});try{o=e.CompressionCommon.detectCompressionSourceEncoding(t)}catch(e){return void r(void 0,e)}n=e.ObjectTools.override({inputEncoding:o,outputEncoding:"ByteArray",useWebWorker:!0,blockSize:65536},n),e.enqueueImmediate((function(){n.useWebWorker&&e.WebWorker.createGlobalWorkerIfNeeded()?e.WebWorker.compressAsync(t,n,r):e.AsyncCompressor.compressAsync(t,n,r)}))},e.decompressAsync=function(t,n,r){if(null==r&&(r=function(){}),null!=t){n=e.ObjectTools.override({inputEncoding:"ByteArray",outputEncoding:"String",useWebWorker:!0,blockSize:65536},n);var o=e.BufferTools.convertToUint8ArrayIfNeeded(t);e.EventLoop.enqueueImmediate((function(){n.useWebWorker&&e.WebWorker.createGlobalWorkerIfNeeded()?e.WebWorker.decompressAsync(o,n,r):e.AsyncDecompressor.decompressAsync(t,n,r)}))}else r(void 0,new TypeError("decompressAsync: undefined or null input received"))},e.createCompressionStream=function(){return e.AsyncCompressor.createCompressionStream()},e.createDecompressionStream=function(){return e.AsyncDecompressor.createDecompressionStream()},e.encodeUTF8=function(t){return e.Encoding.UTF8.encode(t)},e.decodeUTF8=function(t){return e.Encoding.UTF8.decode(t)},e.encodeBase64=function(t){return e.Encoding.Base64.encode(t)},e.decodeBase64=function(t){return e.Encoding.Base64.decode(t)},e.encodeBinaryString=function(t){return e.Encoding.BinaryString.encode(t)},e.decodeBinaryString=function(t){return e.Encoding.BinaryString.decode(t)},e.encodeStorageBinaryString=function(t){return e.Encoding.StorageBinaryString.encode(t)},e.decodeStorageBinaryString=function(t){return e.Encoding.StorageBinaryString.decode(t)}}(LZUTF8||(LZUTF8={}));


</script>
</body>
</html>
